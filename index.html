<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>VALLEY CITY: POLICE INVESTIGATIONS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    #bg-layer {
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
      transition: background-image 0.4s ease-in-out;
    }
    #game-container {
      position: relative;
      width: 100%;
      height: 100vh;
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    #app {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      overflow-y: auto;
    }
    h1, h2, h3 {
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    }
    .title {
      font-size: 1.7rem;
      margin-bottom: 8px;
      text-align: center;
    }
    .subtitle {
      font-size: 0.9rem;
      margin-bottom: 12px;
      opacity: 0.9;
      text-align: center;
    }
    .btn {
      width: 100%;
      padding: 10px 12px;
      margin: 4px 0;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      background: linear-gradient(135deg, #ffb347, #ffcc33);
      color: #000;
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
      transition: transform 0.08s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0,0,0,0.85);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
      opacity: 0.85;
    }
    .btn-secondary {
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .btn-danger {
      background: linear-gradient(135deg, #ff5858, #f857a6);
      color: #fff;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
    }
    .section-card {
      background: rgba(0,0,0,0.75);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 3px 12px rgba(0,0,0,0.8);
    }
    .section-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .col-half {
      flex: 1 1 calc(50% - 4px);
    }
    .input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    textarea {
      border-radius: 10px;
      min-height: 80px;
      resize: vertical;
    }
    .label {
      font-size: 0.8rem;
      opacity: 0.85;
      margin: 4px 0;
    }
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-top: 6px;
    }
    .avatar-option {
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid transparent;
      cursor: pointer;
      background: rgba(0,0,0,0.7);
    }
    .avatar-option img {
      width: 100%;
      height: auto;
      display: block;
    }
    .avatar-option.selected {
      border-color: #ffcc33;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.8);
    }
    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-left: 4px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .small {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .portrait {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.4);
      flex-shrink: 0;
      background: rgba(0,0,0,0.6);
    }
    .portrait img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.24);
    }
    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .chip {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(255,255,255,0.18);
      cursor: pointer;
    }
    .chip:hover {
      background: rgba(255,255,255,0.06);
    }
    .list-item {
      padding: 8px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.14);
      margin-bottom: 6px;
      cursor: pointer;
    }
    .list-item:hover {
      background: rgba(255,255,255,0.04);
    }
    .list-item-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .list-item-sub {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .log-box {
      background: rgba(0,0,0,0.7);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 8px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 0.78rem;
    }
    .log-line-q {
      color: #ffcc33;
      margin-bottom: 2px;
    }
    .log-line-a {
      color: #fff;
      margin-bottom: 6px;
    }
    .stat-bars {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .stat-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
    }
    .stat-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.16);
      overflow: hidden;
    }
    .stat-bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ffb347, #ffcc33);
      width: 0%;
      transition: width 0.2s ease;
    }
    .typewriter {
      min-height: 90px;
      font-size: 0.9rem;
      line-height: 1.35rem;
      white-space: pre-wrap;
    }
    .footer-note {
      font-size: 0.7rem;
      text-align: center;
      opacity: 0.7;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div id="bg-layer"></div>
  <div id="game-container">
    <div id="app"></div>
  </div>

  <script>
    // ---------- REFERÊNCIAS BÁSICAS ----------
    const bgLayer = document.getElementById("bg-layer");
    const app = document.getElementById("app");

    // ---------- AVATARES (MASC/FEM PADRÃO) ----------
    const AVATARS = [
      "avatar_01.png",
      "avatar_02.png",
      "avatar_03.png",
      "avatar_04.png",
      "avatar_05.png",
      "avatar_06.png",
      "avatar_07.png",
      "avatar_08.png",
      "avatar_09.png",
      "avatar_10.png"
    ];

    // ---------- ESTADO GLOBAL ----------
    let gameState = null;
    let currentCaseId = null;
    let interrogationState = {
      suspectId: null,
      stress: 20,
      trust: 50,
      anger: 10,
      log: []
    };
    let typewriterTimer = null;

    // ---------- CASOS (10) ----------
    const CASES = [
      // 1 - VCPD: Homicídio Motel
      {
        id: "vcpd_01",
        agency: "VCPD",
        title: "Homicídio no Motel Skyline",
        difficulty: 2,
        sceneImage: "crime_scene_01.png",
        intro: "Um homem foi encontrado morto em um quarto do Motel Skyline. Gritos foram ouvidos por volta das 23h45. Não há sinais de arrombamento.",
        hasAutopsy: true,
        autopsy: "Vítima masculina, 34 anos. Perfuração única no tórax por arma branca, ângulo descendente. Marcas de defesa nos antebraços indicam luta corpo a corpo. Estimativa de morte entre 23h20 e 23h50.",
        witnesses: [
          {
            id: "w1",
            name: "Recepcionista do Motel",
            portrait: "witness_01.png",
            reliability: "alta",
            initialStatement: "Vi a vítima subir com uma mulher loira de casaco vermelho por volta das 22h50. Cerca de uma hora depois ouvi discussão vinda do quarto.",
            qa: {
              where: "Eu estava na recepção o tempo todo, monitorando entradas e saídas.",
              relation: "Não conhecia a vítima, mas ele já tinha se hospedado algumas vezes com pessoas diferentes.",
              saw: "Além da mulher de casaco vermelho, notei um carro preto parado do outro lado da rua, motor ligado por muito tempo.",
              suspect: "A única pessoa que subiu com ele foi a mulher loira. Não a vi descer pela frente.",
              more: "As câmeras da recepção e do corredor do terceiro andar devem ter registrado a movimentação."
            }
          },
          {
            id: "w2",
            name: "Hóspede do Quarto ao Lado",
            portrait: "witness_02.png",
            reliability: "média",
            initialStatement: "Ouvi uma briga séria, parecia discussão de casal. Depois um barulho forte e silêncio.",
            qa: {
              where: "Eu estava deitado no meu quarto, não abri a porta.",
              relation: "Não conheço a vítima nem a acompanhante.",
              saw: "Só ouvi passos apressados no corredor após a discussão.",
              suspect: "Parecia algo bem pessoal, como ciúmes ou traição.",
              more: "Ouvi um som metálico batendo no chão, como uma faca ou objeto pesado."
            }
          },
          {
            id: "w3",
            name: "Motorista de Aplicativo",
            portrait: "witness_03.png",
            reliability: "baixa",
            initialStatement: "Eu estava estacionado perto do motel. Vi uma mulher entrar corrida em um carro preto por volta de 23h40.",
            qa: {
              where: "Eu estava dentro do meu carro, na rua lateral.",
              relation: "Não conheço ninguém envolvido.",
              saw: "Ela parecia nervosa, mexendo na bolsa como se escondesse algo.",
              suspect: "Achei estranho o carro ficar tanto tempo com farol apagado.",
              more: "Lembro que a placa começava com HZF e terminava com 18."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Clara Mendes",
            portrait: "suspect_01.png",
            age: 29,
            address: "Bairro Riverside, Valley City",
            record: "Sem antecedentes. Histórico de relacionamento conturbado com a vítima.",
            alibi: "Afirma que saiu do motel às 23h10 e foi direto para casa, sozinha.",
            guilty: true,
            motive: "Ciúmes e ameaça de exposição de mensagens íntimas por parte da vítima.",
            evidenceLinks: ["ev1", "ev2", "ev3"]
          },
          {
            id: "s2",
            name: "Marcos Faria",
            portrait: "suspect_02.png",
            age: 37,
            address: "Centro de Valley City",
            record: "Responde por estelionato em outro estado.",
            alibi: "Diz que estava viajando a trabalho. Não apresenta provas sólidas.",
            guilty: false,
            motive: "Interesse financeiro, mas sem ligação direta à cena do crime.",
            evidenceLinks: []
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Câmeras do Corredor",
            type: "vídeo",
            description: "Mostram Clara saindo sozinha às 23h38, escondendo algo no casaco.",
            image: "evidence_doc_01.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev2",
            name: "Faca com Impressões",
            type: "perícia",
            description: "Faca encontrada no banheiro com digitais de Clara e da vítima.",
            image: "evidence_weapon_01.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev3",
            name: "Registro de Placa HZF-718?",
            type: "inteligência",
            description: "Carro registrado em nome da irmã de Clara, usado por ela com frequência.",
            image: "evidence_doc_02.png",
            linkedSuspects: ["s1"]
          }
        ]
      },

      // 2 - VCPD: Assalto loja 24h
      {
        id: "vcpd_02",
        agency: "VCPD",
        title: "Assalto à Loja 24h",
        difficulty: 2,
        sceneImage: "crime_scene_02.png",
        intro: "Uma loja de conveniência 24h foi assaltada. O atendente foi agredido. O suspeito fugiu em uma moto vermelha.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Atendente da Loja",
            portrait: "witness_05.png",
            reliability: "alta",
            initialStatement: "O assaltante usava capuz e gaguejava. Tinha uma tatuagem de asa no pescoço.",
            qa: {
              where: "Eu estava no caixa quando ele apontou a arma.",
              relation: "Nunca o vi antes.",
              saw: "Vi claramente a tatuagem de asa no pescoço esquerdo.",
              suspect: "Pelo jeito de falar, parece alguém da região.",
              more: "Ouvi barulho de moto acelerando logo depois da fuga."
            }
          },
          {
            id: "w2",
            name: "Cliente",
            portrait: "witness_06.png",
            reliability: "média",
            initialStatement: "Eu chegava na loja e vi o cara correr com sacola cheia de dinheiro e subir numa moto vermelha.",
            qa: {
              where: "Eu estava na porta da loja.",
              relation: "Não conheço o suspeito.",
              saw: "Moto vermelha, escapamento barulhento, sem placa visível.",
              suspect: "Ele parecia saber exatamente o que queria.",
              more: "Era alto, moletom escuro e tênis branco."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Lucas 'Asa' Ferreira",
            portrait: "suspect_03.png",
            age: 24,
            address: "Bairro Industrial",
            record: "Furto e receptação. Conhecido por pilotar moto vermelha.",
            alibi: "Afirma que estava em casa jogando videogame, mas o amigo não confirma o horário.",
            guilty: true,
            motive: "Dívidas com traficantes locais.",
            evidenceLinks: ["ev1", "ev2"]
          },
          {
            id: "s2",
            name: "Rogério Silva",
            portrait: "suspect_04.png",
            age: 31,
            address: "Cidade vizinha",
            record: "Ligado a quadrilhas de roubo a lojas.",
            alibi: "Diz que estava fazendo segurança em evento, sem prova visual.",
            guilty: false,
            motive: "Poderia ter interesse, mas nada liga ao local.",
            evidenceLinks: []
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Filmagens Internas",
            type: "vídeo",
            description: "Mostram tatuagem de asa e tênis branco do assaltante.",
            image: "evidence_text_01.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev2",
            name: "Moto Vermelha",
            type: "apreensão",
            description: "Moto vermelha sem placa encontrada na casa de Lucas.",
            image: "evidence_obj_01.png",
            linkedSuspects: ["s1"]
          }
        ]
      },

      // 3 - VCPD: Incêndio suspeito
      {
        id: "vcpd_03",
        agency: "VCPD",
        title: "Incêndio em Apartamento",
        difficulty: 3,
        sceneImage: "crime_scene_03.png",
        intro: "Um incêndio atingiu um apartamento. Perícia encontrou acelerante químico na sala.",
        hasAutopsy: true,
        autopsy: "Vítima feminina, 41 anos. Inalação de fumaça e pancada na região occipital sugerem agressão antes do fogo.",
        witnesses: [
          {
            id: "w1",
            name: "Vizinha",
            portrait: "witness_11.png",
            reliability: "alta",
            initialStatement: "Ouvi uma discussão com voz masculina à noite e, depois de um tempo, cheiro de fumaça.",
            qa: {
              where: "Eu estava no meu apartamento.",
              relation: "Conhecia a vítima de vista.",
              saw: "Não vi quem entrou ou saiu, só ouvi passos apressados.",
              suspect: "Ela comentou ter problemas com o ex-marido.",
              more: "Já vi o ex-marido sair daqui alterado outras vezes."
            }
          },
          {
            id: "w2",
            name: "Porteiro",
            portrait: "witness_12.png",
            reliability: "média",
            initialStatement: "Vi o ex-marido entrar às 19h40 e sair nervoso cerca de 40 minutos depois.",
            qa: {
              where: "Na portaria, fazendo registros.",
              relation: "Conheço de vista, sempre discutindo com ela.",
              saw: "Ele saiu suando, olhando para os lados.",
              suspect: "Pelo histórico de brigas, é meu principal suspeito.",
              more: "O nome dele está no livro de visitas."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Eduardo Lins",
            portrait: "suspect_05.png",
            age: 43,
            address: "Valley City",
            record: "Medida protetiva anterior por violência doméstica.",
            alibi: "Diz que foi para um bar assistir jogo. Ninguém confirma o horário exato.",
            guilty: true,
            motive: "Ciúmes e disputa por bens após separação.",
            evidenceLinks: ["ev1", "ev2"]
          },
          {
            id: "s2",
            name: "Síndico",
            portrait: "suspect_06.png",
            age: 50,
            address: "Mesmo prédio",
            record: "Sem antecedentes.",
            alibi: "Relata estar em reunião em outra torre.",
            guilty: false,
            motive: "Conflitos menores de condomínio, sem peso para homicídio.",
            evidenceLinks: []
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Resquícios de Acelerante",
            type: "perícia",
            description: "Acelerante compatível com combustível usado na oficina onde Eduardo trabalha.",
            image: "evidence_obj_02.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev2",
            name: "Mensagens de Ameaça",
            type: "digital",
            description: "Mensagens recentes de Eduardo com ameaças veladas.",
            image: "evidence_doc_02.png",
            linkedSuspects: ["s1"]
          }
        ]
      },

      // 4 - VCPD: Sequestro relâmpago
      {
        id: "vcpd_04",
        agency: "VCPD",
        title: "Sequestro Relâmpago",
        difficulty: 3,
        sceneImage: "valley_city_night.png",
        intro: "Um empresário foi sequestrado ao sair de um restaurante e forçado a sacar dinheiro em vários caixas.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Vítima",
            portrait: "witness_13.png",
            reliability: "alta",
            initialStatement: "Dois homens armados me abordaram. Um deles parecia saber detalhes da minha rotina.",
            qa: {
              where: "Fui colocado no banco de trás do meu próprio carro.",
              relation: "Não reconheci pela voz ou rosto.",
              saw: "Um fumava muito, o outro falava ao telefone o tempo todo.",
              suspect: "Suspeito de alguém de dentro da empresa.",
              more: "Eles conheciam informações da minha família."
            }
          },
          {
            id: "w2",
            name: "Garçom",
            portrait: "witness_14.png",
            reliability: "média",
            initialStatement: "Vi dois homens observando o empresário dentro do restaurante.",
            qa: {
              where: "Eu servia mesas no salão.",
              relation: "Não conheço nenhum deles.",
              saw: "Um anotava algo no celular enquanto fitava a mesa do empresário.",
              suspect: "Pareciam planejar algo, não era encontro casual.",
              more: "Podem ter feito reserva, está no sistema."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Bruno Carvalho",
            portrait: "suspect_07.png",
            age: 33,
            address: "Bairro Financeiro",
            record: "Sem antecedentes, mas com dívidas altas.",
            alibi: "Afirma estar em home office.",
            guilty: false,
            motive: "Financeiro, mas sem prova de participação.",
            evidenceLinks: []
          },
          {
            id: "s2",
            name: "Rafael Duarte",
            portrait: "suspect_08.png",
            age: 29,
            address: "Bairro Operário",
            record: "Ex-funcionário demitido da empresa da vítima.",
            alibi: "Diz que estava em bar com amigos, sem comprovação.",
            guilty: true,
            motive: "Vingança + uso de informações internas.",
            evidenceLinks: ["ev1", "ev2"]
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Registros de Ligações",
            type: "inteligência",
            description: "Rafael ligou para cúmplice perto do restaurante minutos antes do crime.",
            image: "evidence_text_01.png",
            linkedSuspects: ["s2"]
          },
          {
            id: "ev2",
            name: "Câmeras do Caixa Eletrônico",
            type: "vídeo",
            description: "Imagens mostram Rafael parcialmente encapuzado ao lado da vítima.",
            image: "evidence_doc_01.png",
            linkedSuspects: ["s2"]
          }
        ]
      },

      // 5 - FBI: Rede de tráfico
      {
        id: "fbi_01",
        agency: "FBI",
        title: "Rede de Tráfico Interestadual",
        difficulty: 4,
        sceneImage: "valley_city_day.png",
        intro: "O FBI investiga uma rota de tráfico que usa Valley City como ponto de passagem.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Informante",
            portrait: "witness_15.png",
            reliability: "média",
            initialStatement: "O chefe local nunca encosta na carga. Só manda recado e paga por fora.",
            qa: {
              where: "Fico perto do porto, ouvindo conversas.",
              relation: "Não conheço o chefe pessoalmente.",
              saw: "Vejo sempre o mesmo contato se encontrando em um café perto da rodoviária.",
              suspect: "Esse contato é mais perigoso do que parece.",
              more: "As cargas grandes chegam sempre à noite."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Henrique Costa",
            portrait: "suspect_09.png",
            age: 40,
            address: "Cidade vizinha",
            record: "Empresário de transporte com processos fiscais.",
            alibi: "Diz que faz apenas transporte legal.",
            guilty: true,
            motive: "Uso da frota para lucro clandestino.",
            evidenceLinks: ["ev1", "ev2"]
          },
          {
            id: "s2",
            name: "Carlos Menezes",
            portrait: "suspect_10.png",
            age: 35,
            address: "Valley City",
            record: "Dono do café.",
            alibi: "Afirma que só aluga mesas para reuniões.",
            guilty: false,
            motive: "Lucro indireto, sem prova de envolvimento.",
            evidenceLinks: []
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Rastreamento de Caminhões",
            type: "inteligência",
            description: "Rotas desviam para galpões não cadastrados oficialmente.",
            image: "evidence_obj_03.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev2",
            name: "Mensagens Criptografadas",
            type: "digital",
            description: "Conversas citam 'H.C.' coordenando entregas em Valley City.",
            image: "evidence_doc_02.png",
            linkedSuspects: ["s1"]
          }
        ]
      },

      // 6 - FBI: Ataque cibernético
      {
        id: "fbi_02",
        agency: "FBI",
        title: "Ataque ao Valley City Bank",
        difficulty: 4,
        sceneImage: "case_scene_bg.png",
        intro: "Um ataque cibernético derrubou sistemas do Valley City Bank e desviou pequenas quantias de várias contas.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Analista de TI",
            portrait: "witness_16.png",
            reliability: "alta",
            initialStatement: "O ataque usou acesso interno antes da invasão principal, manipulando nossos logs.",
            qa: {
              where: "Eu monitorava o servidor remotamente.",
              relation: "Trabalho no banco há anos.",
              saw: "Um usuário interno logou em horário incomum antes do ataque.",
              suspect: "Alguém com conhecimento interno ajudou o invasor.",
              more: "Parte dos logs foi apagada de forma profissional."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Ana Ribeiro",
            portrait: "suspect_11.png",
            age: 28,
            address: "Valley City",
            record: "Analista do banco, sem antecedentes.",
            alibi: "Diz que seu usuário foi usado sem permissão.",
            guilty: false,
            motive: "Nenhum indício forte.",
            evidenceLinks: []
          },
          {
            id: "s2",
            name: "Gabriel Torres",
            portrait: "suspect_12.png",
            age: 32,
            address: "Cidade vizinha",
            record: "Hacker investigado em outro estado.",
            alibi: "Afirma estar em evento de tecnologia, sem provas.",
            guilty: true,
            motive: "Lucro financeiro e desafio técnico.",
            evidenceLinks: ["ev1", "ev2"]
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Carteiras Digitais",
            type: "digital",
            description: "Valores desviados convergem para carteiras vinculadas a e-mails usados por Gabriel.",
            image: "evidence_doc_01.png",
            linkedSuspects: ["s2"]
          },
          {
            id: "ev2",
            name: "Ferramentas de Exploit",
            type: "apreensão",
            description: "Scripts iguais aos usados no ataque encontrados em equipamentos de Gabriel.",
            image: "evidence_text_01.png",
            linkedSuspects: ["s2"]
          }
        ]
      },

      // 7 - FBI: Ameaça de bomba falsa
      {
        id: "fbi_03",
        agency: "FBI",
        title: "Ameaça de Bomba em Escola",
        difficulty: 3,
        sceneImage: "police_station_front.png",
        intro: "Uma escola recebeu e-mail com ameaça de bomba. Um artefato falso foi deixado no pátio, causando pânico.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Diretora",
            portrait: "witness_17.png",
            reliability: "alta",
            initialStatement: "O e-mail anônimo chegou minutos antes de encontrarem o pacote.",
            qa: {
              where: "Eu estava na sala da direção.",
              relation: "Não sei quem faria isso.",
              saw: "Câmeras mostram um jovem deixando o pacote no pátio cedo.",
              suspect: "Pode ser ex-aluno ou aluno revoltado.",
              more: "Já tivemos trotes menores antes."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Aluno de Trotes",
            portrait: "suspect_13.png",
            age: 16,
            address: "Valley City",
            record: "Histórico de trotes, advertido.",
            alibi: "Diz que estava em aula o tempo todo.",
            guilty: false,
            motive: "Brincadeira de mau gosto, mas sem prova deste caso.",
            evidenceLinks: []
          },
          {
            id: "s2",
            name: "Ex-Aluno Expulso",
            portrait: "suspect_14.png",
            age: 19,
            address: "Bairro periférico",
            record: "Expulso por agressão.",
            alibi: "Afirma estar trabalhando em depósito, sem registro de ponto.",
            guilty: true,
            motive: "Revanche contra a escola.",
            evidenceLinks: ["ev1"]
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Metadados do E-mail",
            type: "digital",
            description: "Metadados ligam o IP residencial do ex-aluno ao envio da ameaça.",
            image: "evidence_doc_02.png",
            linkedSuspects: ["s2"]
          }
        ]
      },

      // 8 - CIA: Vazamento de dados
      {
        id: "cia_01",
        agency: "CIA",
        title: "Vazamento de Arquivos Sigilosos",
        difficulty: 4,
        sceneImage: "exam_room.png",
        intro: "Arquivos confidenciais sobre operações externas vazaram para a imprensa. Apenas poucas pessoas tinham acesso.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Analista de Segurança",
            portrait: "witness_18.png",
            reliability: "alta",
            initialStatement: "Os arquivos foram copiados em lote, em uma única madrugada, usando credenciais internas.",
            qa: {
              where: "Eu monitorava os acessos em regime de plantão.",
              relation: "Conheço todo o time de análise.",
              saw: "Um terminal que deveria estar desligado foi ativado na madrugada.",
              suspect: "Alguém fisicamente dentro do prédio participou.",
              more: "Foi usado pen drive criptografado para extração."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Agente Sênior",
            portrait: "suspect_15.png",
            age: 45,
            address: "Residência oficial",
            record: "Carreira longa, sem registros negativos.",
            alibi: "Afirma estar em missão externa.",
            guilty: false,
            motive: "Nenhum aparente.",
            evidenceLinks: []
          },
          {
            id: "s2",
            name: "Contratado de TI",
            portrait: "suspect_16.png",
            age: 30,
            address: "Cidade vizinha",
            record: "Sem antecedentes, mas presença em fóruns de vazamento.",
            alibi: "Diz que estava em casa.",
            guilty: true,
            motive: "Motivos ideológicos e financeiros.",
            evidenceLinks: ["ev1", "ev2"]
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Acesso Noturno",
            type: "digital",
            description: "Credenciais do contratado usadas em horário proibido.",
            image: "evidence_doc_01.png",
            linkedSuspects: ["s2"]
          },
          {
            id: "ev2",
            name: "Pagamentos Criptografados",
            type: "inteligência",
            description: "Transferências em criptomoedas ligadas a grupos de vazamento.",
            image: "evidence_text_01.png",
            linkedSuspects: ["s2"]
          }
        ]
      },

      // 9 - CIA: Contato duplo
      {
        id: "cia_02",
        agency: "CIA",
        title: "Contato Duplo em Valley City",
        difficulty: 5,
        sceneImage: "valley_city_night.png",
        intro: "Um contato da agência em Valley City pode estar atuando também para uma potência estrangeira.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Agente de Campo",
            portrait: "witness_19.png",
            reliability: "média",
            initialStatement: "Nos últimos meses, nosso contato mudou o comportamento e passou a evitar encontros oficiais.",
            qa: {
              where: "Atuo em operações de campo na região.",
              relation: "Trabalho com ele há mais de dois anos.",
              saw: "Ele foi visto com um diplomata estrangeiro fora da agenda.",
              suspect: "Pode ter mudado de lado ou estar sendo chantageado.",
              more: "Seus relatórios ficaram vagos e menos úteis."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Contato Local A",
            portrait: "suspect_17.png",
            age: 38,
            address: "Valley City",
            record: "Cooperador antigo.",
            alibi: "Diz que encontros com o diplomata foram coincidência.",
            guilty: true,
            motive: "Pressão financeira e chantagem.",
            evidenceLinks: ["ev1", "ev2"]
          },
          {
            id: "s2",
            name: "Analista Interno",
            portrait: "suspect_18.png",
            age: 34,
            address: "Sede regional",
            record: "Profissional exemplar.",
            alibi: "Sem contato direto com o campo.",
            guilty: false,
            motive: "Nenhum claro.",
            evidenceLinks: []
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Relatórios Cruzados",
            type: "inteligência",
            description: "Dados passados pelo contato batem com vazamentos ao país estrangeiro.",
            image: "evidence_doc_02.png",
            linkedSuspects: ["s1"]
          },
          {
            id: "ev2",
            name: "Fotos de Encontros",
            type: "vigilância",
            description: "Fotos mostram o contato recebendo envelopes de um diplomata.",
            image: "evidence_obj_03.png",
            linkedSuspects: ["s1"]
          }
        ]
      },

      // 10 - CIA: Operação fantasma
      {
        id: "cia_03",
        agency: "CIA",
        title: "Operação Fantasma",
        difficulty: 5,
        sceneImage: "case_scene_bg.png",
        intro: "Uma operação secreta foi comprometida antes de começar. O alvo parecia preparado para a chegada da equipe.",
        hasAutopsy: false,
        autopsy: "",
        witnesses: [
          {
            id: "w1",
            name: "Coordenador da Missão",
            portrait: "witness_20.png",
            reliability: "alta",
            initialStatement: "Apenas quatro pessoas sabiam de todos os detalhes do plano.",
            qa: {
              where: "Eu estava na central de operações.",
              relation: "Coordeno missões desse tipo com frequência.",
              saw: "Os agentes relataram que o local estava vazio, com sinais de contra-vigilância.",
              suspect: "Houve vazamento em nível estratégico.",
              more: "Documentos físicos ficaram em cofre todo o tempo."
            }
          }
        ],
        suspects: [
          {
            id: "s1",
            name: "Analista de Planejamento",
            portrait: "suspect_19.png",
            age: 36,
            address: "Sede principal",
            record: "Histórico impecável.",
            alibi: "Seguiu todos os protocolos oficiais.",
            guilty: false,
            motive: "Nenhum aparente.",
            evidenceLinks: []
          },
          {
            id: "s2",
            name: "Consultor Externo",
            portrait: "suspect_20.png",
            age: 42,
            address: "País estrangeiro",
            record: "Contratado para suporte logístico.",
            alibi: "Diz ter atuado apenas remotamente.",
            guilty: true,
            motive: "Ligação secreta com governo-alvo.",
            evidenceLinks: ["ev1"]
          }
        ],
        evidence: [
          {
            id: "ev1",
            name: "Comunicações Criptografadas",
            type: "inteligência",
            description: "Comunicações entre o consultor e agentes do país-alvo aumentaram nos dias do planejamento.",
            image: "evidence_doc_01.png",
            linkedSuspects: ["s2"]
          }
        ]
      }
    ];

    // Perguntas genéricas de interrogatório
    const INTERROGATION_QUESTIONS = [
      "Onde você estava no momento do crime?",
      "Qual é sua relação com a vítima?",
      "Alguém pode confirmar seu álibi?",
      "Você tinha motivo para machucar a vítima?",
      "Quando foi a última vez que viu a vítima?",
      "Você reconhece as provas apresentadas?"
    ];

    // ---------- FUNÇÕES AUXILIARES ----------
    function setBackground(img) {
      if (!img) return;
      bgLayer.style.backgroundImage = "url('assets/" + img + "')";
    }

    function setHTML(html) {
      if (typewriterTimer) {
        clearInterval(typewriterTimer);
        typewriterTimer = null;
      }
      app.innerHTML = html;
    }

    function ensureGameState() {
      if (!gameState) {
        gameState = {
          version: 1,
          playerName: "Detetive",
          avatar: AVATARS[0],
          agency: "VCPD",
          rank: "Detetive Júnior",
          prestige: 0,
          moral: 70,
          warnings: 0,
          errors: 0,
          solvedCases: [],
          failedCases: [],
          totalInterrogations: 0,
          totalCalls: 0,
          history: []
        };
      }
    }

    function rankDescription() {
      if (!gameState) return "";
      return gameState.rank + " - " + gameState.agency;
    }

    function updatePrestige(delta) {
      gameState.prestige = Math.max(0, Math.min(100, (gameState.prestige || 0) + delta));
    }

    function updateMoral(delta) {
      gameState.moral = Math.max(0, Math.min(100, (gameState.moral || 0) + delta));
    }

    function addHistory(text) {
      if (!gameState.history) gameState.history = [];
      gameState.history.unshift({ text, date: new Date().toISOString() });
      if (gameState.history.length > 30) gameState.history.pop();
    }

    function saveGameToFile() {
      if (!gameState) return;
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gameState));
      const a = document.createElement("a");
      a.setAttribute("href", dataStr);
      a.setAttribute("download", "valley_city_save.json");
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function loadGameFromObject(obj) {
      gameState = obj;
      if (!gameState.version) gameState.version = 1;
      goTo("office");
    }

    function handleFileLoad(ev) {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          loadGameFromObject(data);
        } catch (err) {
          alert("Erro ao carregar save.");
        }
      };
      reader.readAsText(file);
    }

    function getCurrentCase() {
      if (!currentCaseId) return null;
      return CASES.find(c => c.id === currentCaseId) || null;
    }

    function getNextCaseForAgency(agency) {
      const solved = gameState.solvedCases || [];
      return CASES.find(c => c.agency === agency && !solved.includes(c.id)) || null;
    }

    function canRequestPromotion() {
      const solved = (gameState.solvedCases || []).length;
      return (gameState.prestige || 0) >= 80 && solved >= 3;
    }

    function promotePlayer() {
      if (gameState.agency === "VCPD") {
        gameState.agency = "FBI";
        gameState.rank = "Agente de Investigação Júnior";
        addHistory("Promovido para o FBI.");
      } else if (gameState.agency === "FBI") {
        gameState.agency = "CIA";
        gameState.rank = "Analista de Dados Júnior";
        addHistory("Transferido para a CIA.");
      } else {
        // dentro da CIA só melhora o rank
        const r = gameState.rank;
        if (r === "Analista de Dados Júnior") gameState.rank = "Agente Nível 1";
        else if (r === "Agente Nível 1") gameState.rank = "Agente Nível 2";
        else if (r === "Agente Nível 2") gameState.rank = "Agente Nível 3";
        else if (r === "Agente Nível 3") gameState.rank = "Agente Nível 4";
        else if (r === "Agente Nível 4") gameState.rank = "Agente Especial";
        addHistory("Rank interno promovido em " + gameState.agency + ".");
      }
    }

    // ---------- TYPEWRITER ----------
    function startTypewriter(text, elementId, speed) {
      const el = document.getElementById(elementId);
      if (!el) return;
      if (typewriterTimer) clearInterval(typewriterTimer);
      el.textContent = "";
      let i = 0;
      typewriterTimer = setInterval(() => {
        if (i >= text.length) {
          clearInterval(typewriterTimer);
          typewriterTimer = null;
          return;
        }
        el.textContent += text.charAt(i);
        i++;
      }, speed || 25);
    }

    // ---------- TELAS ----------
    function renderStart() {
      setBackground("capa_principal.png");
      const html =
        '<div class="section-card" style="margin-top:12px;">' +
          '<h1 class="title">VALLEY CITY: POLICE INVESTIGATIONS</h1>' +
          '<p class="subtitle">Comece como detetive do VCPD e avance até o FBI e a CIA. Cada caso conta.</p>' +
          '<button class="btn" onclick="goTo(\\'login\\')">Novo Jogo</button>' +
          '<input type="file" id="load-file" accept=".json" style="display:none" />' +
          '<button class="btn btn-secondary" onclick="document.getElementById(\\'load-file\\').click()">Carregar Jogo</button>' +
          '<button class="btn btn-ghost" onclick="goTo(\\'tutorial\\')">Regras & Tutorial</button>' +
          '<p class="footer-note">Seu progresso pode ser salvo em arquivo JSON.</p>' +
        '</div>' +
        '<script>(function(){var i=document.getElementById("load-file");if(i&&!i._vbound){i._vbound=true;i.addEventListener("change",function(e){window.handleFileLoad && window.handleFileLoad(e);});}})();<\/script>';
      setHTML(html);
    }

    function renderTutorial() {
      setBackground("case_scene_bg.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Tutorial & Regras</span></div>' +
          '<p class="section-subtitle">Use testemunhas, provas, laudos e interrogatórios para encontrar o verdadeiro culpado.</p>' +
          '<ul style="font-size:0.8rem;line-height:1.3rem;padding-left:16px;margin-bottom:8px;">' +
            '<li>Você começa como <b>Detetive Júnior</b> no VCPD.</li>' +
            '<li>Cada caso resolvido corretamente aumenta <b>prestígio</b> e pode melhorar sua <b>moral</b>.</li>' +
            '<li>Erros geram advertências. Muitos erros resultam em demissão.</li>' +
            '<li>Com alto prestígio e boa taxa de acertos, você pode ser promovido ao <b>FBI</b> e depois à <b>CIA</b>.</li>' +
            '<li>Salve o jogo em um arquivo JSON e recarregue quando quiser.</li>' +
          '</ul>' +
          '<p class="small">Dica: não conclua o caso sem, pelo menos, uma prova direta ligando o suspeito à ação + álibi suspeito.</p>' +
          '<button class="btn btn-secondary" style="margin-top:8px;" onclick="goTo(\\'start\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderLogin() {
      setBackground("bg_login.png");
      ensureGameState();
      const name = gameState.playerName || "";
      let avatarHtml = "";
      AVATARS.forEach(function(av) {
        const sel = gameState.avatar === av ? " selected" : "";
        avatarHtml +=
          '<div class="avatar-option' + sel + '" data-avatar="' + av + '">' +
            '<img src="assets/' + av + '" alt="Avatar" />' +
          '</div>';
      });
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Identificação do Detetive</span></div>' +
          '<p class="section-subtitle">Defina seu nome e avatar. Eles serão usados em todas as telas.</p>' +
          '<label class="label" for="player-name">Nome do detetive</label>' +
          '<input id="player-name" class="input" placeholder="Digite seu nome..." value="' + name + '"/>' +
          '<label class="label">Escolha seu avatar</label>' +
          '<div class="avatar-grid">' + avatarHtml + '</div>' +
          '<button class="btn" style="margin-top:10px;" onclick="startNewGame()">Continuar</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'start\\')">Voltar</button>' +
        '</div>' +
        '<script>(function(){var items=document.querySelectorAll(".avatar-option");items.forEach(function(el){el.onclick=function(){items.forEach(function(i){i.classList.remove("selected");});el.classList.add("selected");window.setAvatar && window.setAvatar(el.getAttribute("data-avatar"));};});})();<\/script>';
      setHTML(html);
    }

    function renderCutscene() {
      setBackground("valley_city_night.png");
      const text =
"Valley City.\n\nQuando o sol se põe, as luzes dos prédios acendem...\nmas a escuridão verdadeira continua nas ruas.\n\nAssaltos, homicídios, corrupção, tráfico.\nA cidade sangra devagar enquanto os poucos policiais que restam lutam para manter a linha.\n\nHoje, " + (gameState.playerName || "detetive") + ", você começa aqui.\nUm novo detetive em uma guerra que já dura décadas.\n\nSe fizer o seu trabalho, talvez chegue ao FBI.\nSe for excepcional, talvez à CIA.\n\nMas se falhar... Valley City não perdoa.";
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Valley City</span><span class="badge">Cutscene</span></div>' +
          '<div id="cutscene-text" class="typewriter"></div>' +
          '<button class="btn" style="margin-top:10px;" onclick="goTo(\\'captainBrief\\')">Ir para o Distrito Policial</button>' +
        '</div>';
      setHTML(html);
      startTypewriter(text, "cutscene-text", 25);
    }

    function renderCaptainBrief() {
      setBackground("capitao_office.png");
      const name = gameState.playerName || "detetive";
      const text =
"Valley City não é um lugar fácil, " + name + ".\n\nPoucos policiais, muitos crimes e quase ninguém disposto a falar a verdade.\n\nVocê começa hoje como Detetive Júnior neste distrito. O trabalho, no papel, é simples:\nouvir testemunhas, analisar provas e apontar o culpado certo.\n\nAqui não existe ‘quase certo’.\nCada erro te dá uma advertência e puxa seu prestígio para baixo.\n\nResolva os casos com precisão e ética.\nTalvez eu recomende seu nome ao FBI... quem sabe, um dia, à CIA.\n\nBoa sorte, " + name + ".\nE não pise na bola.\nSe você falhar, eu não vou hesitar em te demitir.";
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Bem-vindo ao Distrito</span><span class="badge">Capitão</span></div>' +
          '<div class="flex" style="margin-bottom:8px;">' +
            '<div class="portrait"><img src="assets/capitao_brief.png" alt="Capitão"/></div>' +
            '<div class="small">Leia com atenção. Essas serão as regras não escritas da sua carreira em Valley City.</div>' +
          '</div>' +
          '<div id="brief-text" class="typewriter"></div>' +
          '<button class="btn" style="margin-top:10px;" onclick="goTo(\\'office\\')">Ir para o Escritório</button>' +
        '</div>';
      setHTML(html);
      startTypewriter(text, "brief-text", 23);
    }

    function renderOffice() {
      ensureGameState();
      setBackground("escritorio_detective.png");
      const solved = (gameState.solvedCases || []).length;
      const failed = (gameState.failedCases || []).length;
      const canPromo = canRequestPromotion();
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Escritório do Detetive</span><span class="badge">' + rankDescription() + '</span></div>' +
          '<div class="flex" style="margin-bottom:8px;">' +
            '<div class="portrait"><img src="assets/' + gameState.avatar + '" alt="Avatar"/></div>' +
            '<div style="font-size:0.8rem;">' +
              '<div><b>' + gameState.playerName + '</b></div>' +
              '<div class="small">Prestígio: ' + gameState.prestige + '% • Moral: ' + gameState.moral + '%</div>' +
              '<div class="small">Casos corretos: ' + solved + ' • Casos errados: ' + failed + '</div>' +
              '<div class="small">Advertências: ' + gameState.warnings + ' | Erros graves: ' + gameState.errors + '</div>' +
            '</div>' +
          '</div>' +
          '<div class="row">' +
            '<div class="col-half"><button class="btn" onclick="goTo(\\'nextCase\\')">Próximo Caso</button></div>' +
            '<div class="col-half"><button class="btn btn-secondary" onclick="goTo(\\'phone\\')">Telefone</button></div>' +
          '</div>' +
          '<div class="row">' +
            '<div class="col-half"><button class="btn btn-secondary" onclick="goTo(\\'stats\\')">Estatísticas</button></div>' +
            '<div class="col-half"><button class="btn btn-secondary" onclick="goTo(\\'tutorial\\')">Regras</button></div>' +
          '</div>' +
          '<button class="btn btn-secondary" onclick="saveGameToFile()">Salvar Jogo (JSON)</button>' +
          '<button class="btn btn-danger" onclick="goTo(\\'resign\\')">Pedir Demissão</button>' +
          '<button class="btn ' + (canPromo ? '' : 'btn-secondary') + '" style="margin-top:6px;" onclick="goTo(\\'promotion\\')">' +
            (canPromo ? 'Candidatar-se à Promoção' : 'Promoção (80% prestígio + 3 casos corretos)') +
          '</button>' +
        '</div>';
      setHTML(html);
    }

    function renderNextCase() {
      ensureGameState();
      const next = getNextCaseForAgency(gameState.agency);
      if (!next) {
        setBackground("police_station_front.png");
        const html =
          '<div class="section-card">' +
            '<div class="section-title"><span>Sem novos casos</span></div>' +
            '<p class="section-subtitle">Nenhum caso disponível para sua agência no momento.</p>' +
            '<button class="btn" onclick="goTo(\\'office\\')">Voltar ao Escritório</button>' +
          '</div>';
        setHTML(html);
        return;
      }
      currentCaseId = next.id;
      setBackground(next.sceneImage || "case_scene_bg.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Novo Caso</span><span class="badge">' + next.agency + '</span></div>' +
          '<p class="section-subtitle"><b>' + next.title + '</b></p>' +
          '<p class="small">' + next.intro + '</p>' +
          '<img class="thumb" src="assets/' + next.sceneImage + '" alt="Cena do crime"/>' +
          '<button class="btn" style="margin-top:10px;" onclick="goTo(\\'case\\')">Entrar na Investigação</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'office\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderCase() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      setBackground(c.sceneImage || "case_scene_bg.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>' + c.title + '</span><span class="badge">' + c.agency + '</span></div>' +
          '<p class="section-subtitle">' + c.intro + '</p>' +
          '<div class="row" style="margin-top:6px;">' +
            '<div class="col-half"><button class="btn" onclick="goTo(\\'witnesses\\')">Testemunhas</button></div>' +
            '<div class="col-half"><button class="btn" onclick="goTo(\\'evidence\\')">Provas & Perícia</button></div>' +
          '</div>' +
          '<div class="row">' +
            '<div class="col-half"><button class="btn btn-secondary" onclick="goTo(\\'suspects\\')">Suspeitos</button></div>' +
            '<div class="col-half"><button class="btn btn-danger" onclick="goTo(\\'conclude\\')">Concluir Caso</button></div>' +
          '</div>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'office\\')">Voltar ao Escritório</button>' +
          '<p class="footer-note">Compare depoimentos com álibis e provas que ligam diretamente o suspeito ao crime.</p>' +
        '</div>';
      setHTML(html);
    }

    function renderWitnesses() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      setBackground("witness_room.png");
      let html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Testemunhas</span><span class="badge">Caso atual</span></div>' +
          '<p class="section-subtitle">Ouça os relatos e faça perguntas específicas.</p>';
      c.witnesses.forEach(function(w) {
        html +=
          '<div class="list-item" onclick="openWitness(\\'' + w.id + '\\')">' +
            '<div class="flex">' +
              '<div class="portrait"><img src="assets/' + w.portrait + '" alt="' + w.name + '"/></div>' +
              '<div>' +
                '<div class="list-item-title">' + w.name + '</div>' +
                '<div class="list-item-sub">Confiabilidade: ' + w.reliability + '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
      });
      html +=
          '<button class="btn btn-secondary" onclick="goTo(\\'case\\')">Voltar ao Caso</button>' +
        '</div>';
      setHTML(html);
    }

    function renderWitnessDetail(wid) {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      const w = c.witnesses.find(function(x){return x.id === wid;});
      if (!w) { goTo("witnesses"); return; }
      setBackground("witness_room.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>' + w.name + '</span><span class="badge">Depoimento</span></div>' +
          '<div class="flex" style="margin-bottom:6px;">' +
            '<div class="portrait"><img src="assets/' + w.portrait + '" alt="' + w.name + '"/></div>' +
            '<div class="small"><b>Relato inicial</b><br/>' + w.initialStatement + '</div>' +
          '</div>' +
          '<div class="label">Perguntas rápidas</div>' +
          '<div class="chip-list">' +
            '<div class="chip" onclick="askWitness(\\'' + w.id + '\\',\\'where\\')">Onde você estava?</div>' +
            '<div class="chip" onclick="askWitness(\\'' + w.id + '\\',\\'relation\\')">Você conhecia a vítima?</div>' +
            '<div class="chip" onclick="askWitness(\\'' + w.id + '\\',\\'saw\\')">O que você viu?</div>' +
            '<div class="chip" onclick="askWitness(\\'' + w.id + '\\',\\'suspect\\')">Quem você suspeita?</div>' +
            '<div class="chip" onclick="askWitness(\\'' + w.id + '\\',\\'more\\')">Algo mais?</div>' +
          '</div>' +
          '<div class="label" style="margin-top:8px;">Pergunta livre</div>' +
          '<input id="witness-question" class="input" placeholder="Digite uma pergunta..." />' +
          '<button class="btn btn-secondary" onclick="askWitnessFree(\\'' + w.id + '\\')">Perguntar</button>' +
          '<div class="label" style="margin-top:8px;">Resumo das respostas</div>' +
          '<div id="witness-log" class="log-box"><p class="small">Use as perguntas acima. O relato inicial não se repete.</p></div>' +
          '<button class="btn btn-secondary" style="margin-top:8px;" onclick="goTo(\\'witnesses\\')">Voltar à lista</button>' +
        '</div>';
      setHTML(html);
    }

    function renderEvidence() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      setBackground("evidence_room.png");
      let html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Provas & Perícia</span><span class="badge">' + c.agency + '</span></div>' +
          '<p class="section-subtitle">Analise documentos, objetos e laudos que ligam suspeitos ao crime.</p>';
      c.evidence.forEach(function(ev){
        html +=
          '<div class="list-item">' +
            '<div class="list-item-title">' + ev.name + '</div>' +
            '<div class="list-item-sub">' + ev.type + '</div>' +
            '<p class="small" style="margin-top:4px;">' + ev.description + '</p>' +
            (ev.image ? '<img class="thumb" src="assets/' + ev.image + '" alt="' + ev.name + '"/>' : '') +
          '</div>';
      });
      if (c.hasAutopsy) {
        html += '<button class="btn" style="margin-top:8px;" onclick="goTo(\\'autopsy\\')">Laudo do Legista</button>';
      }
      html += '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'case\\')">Voltar ao Caso</button></div>';
      setHTML(html);
    }

    function renderAutopsy() {
      const c = getCurrentCase();
      if (!c || !c.hasAutopsy) { goTo("evidence"); return; }
      setBackground("morgue_room.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>IML - Laudo do Legista</span><span class="badge">Perícia</span></div>' +
          '<div class="flex" style="margin-bottom:6px;">' +
            '<div class="portrait"><img src="assets/perito_legista.png" alt="Perito"/></div>' +
            '<div class="small">' + c.autopsy + '</div>' +
          '</div>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'evidence\\')">Voltar às Provas</button>' +
        '</div>';
      setHTML(html);
    }

    function renderSuspects() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      setBackground("suspect_file_bg.png");
      let html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Suspeitos</span><span class="badge">' + c.agency + '</span></div>' +
          '<p class="section-subtitle">Confira histórico, álibi e possíveis ligações com as provas.</p>';
      c.suspects.forEach(function(s) {
        html +=
          '<div class="list-item" onclick="openSuspect(\\'' + s.id + '\\')">' +
            '<div class="flex">' +
              '<div class="portrait"><img src="assets/' + s.portrait + '" alt="' + s.name + '"/></div>' +
              '<div>' +
                '<div class="list-item-title">' + s.name + '</div>' +
                '<div class="list-item-sub">Idade: ' + s.age + ' • Endereço: ' + s.address + '</div>' +
                '<div class="small">Registro: ' + s.record + '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
      });
      html += '<button class="btn btn-secondary" onclick="goTo(\\'case\\')">Voltar ao Caso</button></div>';
      setHTML(html);
    }

    function renderSuspectDetail(sid) {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      const s = c.suspects.find(function(x){return x.id === sid;});
      if (!s) { goTo("suspects"); return; }
      setBackground("suspect_file_bg.png");
      const related = c.evidence.filter(function(ev){return (ev.linkedSuspects || []).indexOf(s.id) !== -1;});
      let html =
        '<div class="section-card">' +
          '<div class="section-title"><span>' + s.name + '</span><span class="badge">Suspeito</span></div>' +
          '<div class="flex" style="margin-bottom:6px;">' +
            '<div class="portrait"><img src="assets/' + s.portrait + '" alt="' + s.name + '"/></div>' +
            '<div class="small">' +
              '<b>Idade:</b> ' + s.age + '<br/>' +
              '<b>Endereço:</b> ' + s.address + '<br/>' +
              '<b>Registro:</b> ' + s.record + '<br/>' +
              '<b>Álibi:</b> ' + s.alibi + '<br/>' +
              (s.motive ? '<b>Motivo possível:</b> ' + s.motive : '') +
            '</div>' +
          '</div>' +
          '<div class="label">Provas ligadas a este suspeito</div>';
      if (!related.length) {
        html += '<p class="small">Nenhuma evidência direta registrada até o momento.</p>';
      } else {
        related.forEach(function(ev){
          html +=
            '<div class="list-item">' +
              '<div class="list-item-title">' + ev.name + '</div>' +
              '<div class="list-item-sub">' + ev.type + '</div>' +
              '<p class="small" style="margin-top:4px;">' + ev.description + '</p>' +
            '</div>';
        });
      }
      html +=
          '<button class="btn" style="margin-top:6px;" onclick="goTo(\\'interrogation_' + s.id + '\\')">Interrogar Suspeito</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'suspects\\')">Voltar à lista</button>' +
        '</div>';
      setHTML(html);
    }

    function renderInterrogation(sid) {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      const s = c.suspects.find(function(x){return x.id === sid;});
      if (!s) { goTo("suspects"); return; }
      interrogationState.suspectId = sid;
      if (!interrogationState.log) interrogationState.log = [];
      setBackground("interrogation_room.png");
      let qchips = "";
      INTERROGATION_QUESTIONS.forEach(function(q, idx){
        qchips += '<div class="chip" onclick="askSuspectTemplate(\\'' + sid + '\\',' + idx + ')">' + (idx+1) + '. ' + q + '</div>';
      });
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Interrogatório: ' + s.name + '</span><span class="badge">Sala de Interrogatório</span></div>' +
          '<div class="flex" style="margin-bottom:6px;">' +
            '<div class="portrait"><img src="assets/' + s.portrait + '" alt="' + s.name + '"/></div>' +
            '<div class="small"><b>Álibi:</b> ' + s.alibi + '</div>' +
          '</div>' +
          '<div class="stat-bars">' +
            '<div class="stat-row"><span>Stress</span><div class="stat-bar"><div id="bar-stress" class="stat-bar-fill"></div></div></div>' +
            '<div class="stat-row"><span>Confiança</span><div class="stat-bar"><div id="bar-trust" class="stat-bar-fill"></div></div></div>' +
            '<div class="stat-row"><span>Raiva</span><div class="stat-bar"><div id="bar-anger" class="stat-bar-fill"></div></div></div>' +
          '</div>' +
          '<div class="label" style="margin-top:4px;">Perguntas sugeridas</div>' +
          '<div class="chip-list">' + qchips + '</div>' +
          '<div class="label" style="margin-top:8px;">Pergunta livre</div>' +
          '<textarea id="suspect-question" placeholder="Digite sua pergunta..."></textarea>' +
          '<button class="btn btn-secondary" onclick="askSuspect(\\'' + sid + '\\')">Perguntar</button>' +
          '<div class="label" style="margin-top:8px;">Registro do interrogatório</div>' +
          '<div id="interrogation-log" class="log-box"><p class="small">As respostas mudam conforme stress, confiança e raiva.</p></div>' +
          '<button class="btn btn-secondary" style="margin-top:8px;" onclick="goTo(\\'suspects\\')">Encerrar interrogatório</button>' +
        '</div>';
      setHTML(html);
      updateInterrogationBars();
      renderInterrogationLog();
    }

    function renderConclude() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      setBackground(c.sceneImage || "case_scene_bg.png");
      let options = '<option value="">-- Selecione --</option>';
      c.suspects.forEach(function(s){
        options += '<option value="' + s.id + '">' + s.name + '</option>';
      });
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Concluir Caso</span><span class="badge">' + c.title + '</span></div>' +
          '<p class="section-subtitle">Escolha o suspeito que você considera culpado com base em todas as informações.</p>' +
          '<label class="label" for="suspect-select">Suspeito culpado</label>' +
          '<select id="suspect-select" class="input">' + options + '</select>' +
          '<button class="btn btn-danger" onclick="finalizeCase()">Confirmar Conclusão</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'case\\')">Voltar ao Caso</button>' +
          '<p class="footer-note">Escolhas erradas geram advertências e podem levar à demissão.</p>' +
        '</div>';
      setHTML(html);
    }

    function renderStats() {
      ensureGameState();
      setBackground("promotion_bg.png");
      const solved = (gameState.solvedCases || []).length;
      const failed = (gameState.failedCases || []).length;
      let hist = "";
      if (!gameState.history || !gameState.history.length) {
        hist = "<p class='small'>Sem registros ainda.</p>";
      } else {
        gameState.history.forEach(function(h){
          hist += "<div class='log-line-a'>• " + h.text + "</div>";
        });
      }
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Estatísticas de Carreira</span></div>' +
          '<p class="small"><b>' + gameState.playerName + '</b> • ' + rankDescription() + '<br/>Prestígio: ' + gameState.prestige + '% • Moral: ' + gameState.moral + '%</p>' +
          '<p class="small" style="margin-top:6px;">Casos corretos: ' + solved + '<br/>Casos errados: ' + failed + '<br/>Interrogatórios: ' + (gameState.totalInterrogations || 0) + '<br/>Ligações: ' + (gameState.totalCalls || 0) + '</p>' +
          '<div class="label" style="margin-top:8px;">Histórico recente</div>' +
          '<div class="log-box">' + hist + '</div>' +
          '<button class="btn btn-secondary" style="margin-top:8px;" onclick="goTo(\\'office\\')">Voltar ao Escritório</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPhone() {
      setBackground("phone_interface.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Telefone do Distrito</span></div>' +
          '<p class="section-subtitle">Use ligações estratégicas para melhorar sua carreira e aprofundar investigações.</p>' +
          '<button class="btn" onclick="goTo(\\'phone_chief\\')">Ligar para o Capitão</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'phone_forensics\\')">Ligar para o Perito</button>' +
          '<button class="btn btn-secondary" onclick="goTo(\\'phone_street\\')">Acionar Equipe de Rua</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'office\\')">Voltar ao Escritório</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPhoneChief() {
      setBackground("capitao_office.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Ligação ao Capitão</span></div>' +
          '<p class="section-subtitle">Como você vai conduzir essa conversa?</p>' +
          '<button class="btn" onclick="callChief(\\'apologize\\')">Pedir desculpas por erros</button>' +
          '<button class="btn" onclick="callChief(\\'praise_team\\')">Elogiar a equipe</button>' +
          '<button class="btn" onclick="callChief(\\'praise_chief\\')">Elogiar o capitão</button>' +
          '<button class="btn btn-danger" onclick="goTo(\\'resign\\')">Pedir demissão</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'phone\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPhoneForensics() {
      setBackground("exam_room.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Perito Legista</span></div>' +
          '<p class="small">Você discute detalhes técnicos de laudos, tempos de morte e compatibilidade de provas.</p>' +
          '<p class="small" style="margin-top:4px;"><b>Efeito:</b> leve aumento de moral e prestígio por zelo técnico.</p>' +
          '<button class="btn" onclick="callForensics()">Registrar conversa</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'phone\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPhoneStreet() {
      setBackground("valley_city_day.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Equipe de Rua</span></div>' +
          '<p class="small">A equipe de rua verifica endereços, câmeras e cumpre mandados narrativamente.</p>' +
          '<button class="btn" onclick="callStreet()">Acionar equipe</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'phone\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPromotion() {
      ensureGameState();
      setBackground("promotion_bg.png");
      const canPromo = canRequestPromotion();
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Promoção de Carreira</span></div>' +
          '<p class="section-subtitle">Para ser promovido, você precisa de 80% de prestígio e, pelo menos, 3 casos resolvidos corretamente.</p>' +
          '<p class="small">Prestígio atual: ' + gameState.prestige + '% • Casos corretos: ' + (gameState.solvedCases || []).length + '</p>' +
          (canPromo
            ? '<button class="btn" style="margin-top:8px;" onclick="goTo(\\'promotion_exam\\')">Iniciar Prova</button>'
            : '<p class="small" style="margin-top:8px;">Continue resolvendo casos com precisão para se qualificar.</p>') +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'office\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderPromotionExam() {
      setBackground("promotion_bg.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Prova de Promoção</span></div>' +
          '<p class="section-subtitle">Esta versão assume que você foi aprovado caso já cumpra os requisitos.</p>' +
          '<button class="btn" style="margin-top:8px;" onclick="finishPromotionExam()">Concluir Prova</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'promotion\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderResign() {
      setBackground("fired_screen.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Pedir Demissão</span></div>' +
          '<p class="section-subtitle">Tem certeza de que deseja encerrar sua carreira em Valley City?</p>' +
          '<button class="btn btn-danger" onclick="confirmResign()">Confirmar Demissão</button>' +
          '<button class="btn btn-secondary" style="margin-top:6px;" onclick="goTo(\\'office\\')">Voltar</button>' +
        '</div>';
      setHTML(html);
    }

    function renderFired(summary) {
      setBackground("fired_screen.png");
      const html =
        '<div class="section-card">' +
          '<div class="section-title"><span>Você foi desligado</span></div>' +
          '<p class="section-subtitle">' + summary + '</p>' +
          '<button class="btn" style="margin-top:10px;" onclick="goTo(\\'start\\')">Voltar ao Início</button>' +
        '</div>';
      setHTML(html);
    }

    // ---------- INTERROGATÓRIO ----------
    function updateInterrogationBars() {
      const s = interrogationState;
      function set(id, val) {
        const el = document.getElementById(id);
        if (el) el.style.width = Math.max(0, Math.min(100, val)) + "%";
      }
      set("bar-stress", s.stress);
      set("bar-trust", s.trust);
      set("bar-anger", s.anger);
    }

    function renderInterrogationLog() {
      const logBox = document.getElementById("interrogation-log");
      if (!logBox) return;
      const log = interrogationState.log || [];
      if (!log.length) {
        logBox.innerHTML = "<p class='small'>Nenhuma pergunta registrada ainda.</p>";
        return;
      }
      let html = "";
      log.forEach(function(item){
        html += "<div class='log-line-q'><b>Pergunta:</b> " + item.q + "</div>";
        html += "<div class='log-line-a'><b>Resposta:</b> " + item.a + "</div>";
      });
      logBox.innerHTML = html;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function generateSuspectAnswer(c, s, question) {
      const q = question.toLowerCase();
      if (q.indexOf("onde") !== -1 || q.indexOf("where") !== -1) {
        return "Eu já disse: meu álibi é \"" + s.alibi + "\".";
      }
      if (q.indexOf("vítima") !== -1 || q.indexOf("vitima") !== -1) {
        return "Minha relação com a vítima é essa: " + (s.motive || "nenhuma desavença direta conhecida.");
      }
      if (q.indexOf("motivo") !== -1 || q.indexOf("por que") !== -1 || q.indexOf("porque") !== -1) {
        if (s.motive) return "Motivo? Você já tem aí: " + s.motive;
        return "Eu não tinha qualquer motivo real para fazer isso.";
      }
      if (q.indexOf("prova") !== -1 || q.indexOf("evidência") !== -1) {
        const ev = c.evidence.filter(function(ev){return (ev.linkedSuspects||[]).indexOf(s.id)!==-1;});
        if (!ev.length) return "Até onde sei, não há nenhuma prova direta contra mim.";
        return "Vocês estão se apoiando em " + ev.map(function(e){return e.name;}).join(", ") + ", mas isso não conta a história inteira.";
      }
      if (q.indexOf("confesse") !== -1 || q.indexOf("confissão") !== -1) {
        if (s.guilty) return "Mesmo que eu tivesse algo a confessar, não faria isso sem um advogado presente.";
        return "Não tenho o que confessar, porque não fiz nada.";
      }
      if (q.indexOf("última vez") !== -1 || q.indexOf("ultima vez") !== -1) {
        return "A última vez que vi a vítima foi " + (s.guilty ? "pouco antes de tudo acontecer." : "dias antes desse caos começar.");
      }
      if (s.guilty) {
        return "Você está insistindo demais. Eu já respondi o suficiente.";
      } else {
        return "Eu já falei tudo que sei. Repetir não vai mudar os fatos.";
      }
    }

    // ---------- LÓGICA DO CASO ----------
    function finalizeCase() {
      const c = getCurrentCase();
      if (!c) { goTo("office"); return; }
      const sel = document.getElementById("suspect-select");
      if (!sel || !sel.value) {
        alert("Selecione um suspeito antes de concluir o caso.");
        return;
      }
      const sid = sel.value;
      const chosen = c.suspects.find(function(x){return x.id === sid;});
      if (!chosen) {
        alert("Seleção inválida.");
        return;
      }
      const correct = !!chosen.guilty;
      if (correct) {
        if (gameState.solvedCases.indexOf(c.id) === -1) {
          gameState.solvedCases.push(c.id);
        }
        updatePrestige(10);
        updateMoral(3);
        addHistory("Caso resolvido corretamente: " + c.title + ". Culpado: " + chosen.name + ".");
        alert("Você acertou o culpado. Boa investigação.");
      } else {
        if (gameState.failedCases.indexOf(c.id) === -1) {
          gameState.failedCases.push(c.id);
        }
        gameState.errors = (gameState.errors || 0) + 1;
        gameState.warnings = (gameState.warnings || 0) + 1;
        updatePrestige(-12);
        updateMoral(-8);
        addHistory("Conclusão equivocada no caso: " + c.title + ". Você acusou " + chosen.name + " injustamente.");
        if (gameState.errors >= 6) {
          renderFired("Seus erros graves acumularam e o capitão decidiu encerrar sua carreira em Valley City.");
          return;
        } else {
          alert("Você errou o culpado. Advertência registrada e prestígio reduzido.");
        }
      }
      currentCaseId = null;
      goTo("office");
    }

    // ---------- FUNÇÕES GLOBAIS PARA ONCLICK ----------
    function goTo(screenId) {
      switch (screenId) {
        case "start": renderStart(); break;
        case "tutorial": renderTutorial(); break;
        case "login": renderLogin(); break;
        case "cutscene": renderCutscene(); break;
        case "captainBrief": renderCaptainBrief(); break;
        case "office": renderOffice(); break;
        case "nextCase": renderNextCase(); break;
        case "case": renderCase(); break;
        case "witnesses": renderWitnesses(); break;
        case "evidence": renderEvidence(); break;
        case "autopsy": renderAutopsy(); break;
        case "suspects": renderSuspects(); break;
        case "conclude": renderConclude(); break;
        case "stats": renderStats(); break;
        case "phone": renderPhone(); break;
        case "phone_chief": renderPhoneChief(); break;
        case "phone_forensics": renderPhoneForensics(); break;
        case "phone_street": renderPhoneStreet(); break;
        case "promotion": renderPromotion(); break;
        case "promotion_exam": renderPromotionExam(); break;
        case "resign": renderResign(); break;
        default:
          if (screenId.indexOf("witness_") === 0) {
            renderWitnessDetail(screenId.replace("witness_",""));
          } else if (screenId.indexOf("suspect_") === 0) {
            renderSuspectDetail(screenId.replace("suspect_",""));
          } else if (screenId.indexOf("interrogation_") === 0) {
            renderInterrogation(screenId.replace("interrogation_",""));
          } else {
            renderStart();
          }
      }
    }

    function startNewGame() {
      ensureGameState();
      const input = document.getElementById("player-name");
      if (input && input.value.trim()) {
        gameState.playerName = input.value.trim();
      }
      goTo("cutscene");
    }

    function setAvatar(av) {
      ensureGameState();
      gameState.avatar = av;
    }

    function openWitness(wid) {
      goTo("witness_" + wid);
    }

    function askWitness(wid, key) {
      const c = getCurrentCase();
      if (!c) return;
      const w = c.witnesses.find(function(x){return x.id === wid;});
      if (!w) return;
      const box = document.getElementById("witness-log");
      if (!box) return;
      const map = {
        where:"Onde você estava no momento do crime?",
        relation:"Você conhecia a vítima?",
        saw:"O que você viu exatamente?",
        suspect:"Quem você suspeita?",
        more:"Você tem mais alguma informação importante?"
      };
      const pergunta = map[key] || "Pergunta";
      const resposta = (w.qa && w.qa[key]) ? w.qa[key] : "Sobre isso, eu realmente não sei informar.";
      box.innerHTML += "<div class='log-line-q'><b>" + pergunta + "</b></div><div class='log-line-a'>" + resposta + "</div>";
      box.scrollTop = box.scrollHeight;
    }

    function askWitnessFree(wid) {
      const input = document.getElementById("witness-question");
      if (!input) return;
      const q = input.value.trim();
      if (!q) return;
      input.value = "";
      const c = getCurrentCase();
      if (!c) return;
      const w = c.witnesses.find(function(x){return x.id === wid;});
      if (!w) return;
      const box = document.getElementById("witness-log");
      if (!box) return;
      const lower = q.toLowerCase();
      let key = "more";
      if (lower.indexOf("onde") !== -1 || lower.indexOf("where") !== -1) key = "where";
      else if (lower.indexOf("vítima") !== -1 || lower.indexOf("vitima") !== -1) key = "relation";
      else if (lower.indexOf("viu") !== -1) key = "saw";
      else if (lower.indexOf("suspeita") !== -1 || lower.indexOf("culpado") !== -1) key = "suspect";
      const resposta = (w.qa && w.qa[key]) ? w.qa[key] : "Sobre isso, eu realmente não sei informar.";
      box.innerHTML += "<div class='log-line-q'><b>Pergunta livre:</b> " + q + "</div><div class='log-line-a'>" + resposta + "</div>";
      box.scrollTop = box.scrollHeight;
    }

    function openSuspect(sid) {
      goTo("suspect_" + sid);
    }

    function askSuspectTemplate(sid, idx) {
      const q = INTERROGATION_QUESTIONS[idx] || "";
      if (!q) return;
      askSuspectInternal(sid, q);
    }

    function askSuspect(sid) {
      const ta = document.getElementById("suspect-question");
      if (!ta) return;
      const q = ta.value.trim();
      if (!q) return;
      ta.value = "";
      askSuspectInternal(sid, q);
    }

    function askSuspectInternal(sid, q) {
      const c = getCurrentCase();
      if (!c) return;
      const s = c.suspects.find(function(x){return x.id === sid;});
      if (!s) return;
      const st = interrogationState;
      const lower = q.toLowerCase();
      if (lower.indexOf("motivo") !== -1 || lower.indexOf("por que") !== -1 || lower.indexOf("porque") !== -1) {
        st.stress += 8; st.anger += 8; st.trust -= 5;
      } else if (lower.indexOf("confesse") !== -1 || lower.indexOf("confissão") !== -1) {
        st.stress += 10; st.anger += 10; st.trust -= 12;
      } else if (lower.indexOf("por favor") !== -1 || lower.indexOf("seja sincero") !== -1) {
        st.trust += 6; st.stress -= 3;
      } else {
        st.stress += 3;
      }
      st.stress = Math.max(0, Math.min(100, st.stress));
      st.trust = Math.max(0, Math.min(100, st.trust));
      st.anger = Math.max(0, Math.min(100, st.anger + 1));
      const answer = generateSuspectAnswer(c, s, q);
      if (!st.log) st.log = [];
      st.log.push({ q: q, a: answer });
      updateInterrogationBars();
      renderInterrogationLog();
      gameState.totalInterrogations = (gameState.totalInterrogations || 0) + 1;
    }

    function callChief(mode) {
      gameState.totalCalls = (gameState.totalCalls || 0) + 1;
      if (mode === "apologize") {
        updateMoral(6); updatePrestige(3);
        addHistory("Você ligou para o capitão e assumiu erros anteriores com maturidade.");
        alert("O capitão aprecia a honestidade. Moral e prestígio aumentaram levemente.");
      } else if (mode === "praise_team") {
        updateMoral(4); updatePrestige(4);
        addHistory("Você reconheceu o trabalho da equipe. O clima no distrito melhorou.");
        alert("Elogiar a equipe gera respeito mútuo. Moral e prestígio subiram.");
      } else if (mode === "praise_chief") {
        updatePrestige(2);
        addHistory("Você elogiou o capitão diretamente. Ele registrou.");
        alert("O capitão registra seu elogio com um meio sorriso.");
      }
      goTo("phone");
    }

    function callForensics() {
      gameState.totalCalls = (gameState.totalCalls || 0) + 1;
      updateMoral(2); updatePrestige(1);
      addHistory("Você consultou o perito sobre detalhes técnicos de laudos.");
      alert("A conversa técnica com o perito ajuda a interpretar melhor as provas.");
      goTo("phone");
    }

    function callStreet() {
      gameState.totalCalls = (gameState.totalCalls || 0) + 1;
      addHistory("Você acionou a equipe de rua para verificações de campo.");
      alert("A equipe de rua está em movimento. Novas pistas podem surgir narrativamente em alguns casos.");
      goTo("phone");
    }

    function finishPromotionExam() {
      if (!canRequestPromotion()) {
        alert("Você ainda não cumpre os requisitos formais.");
        goTo("promotion");
        return;
      }
      promotePlayer();
      updatePrestige(5);
      updateMoral(5);
      alert("Você foi aprovado na prova de promoção. Nova fase da carreira liberada.");
      goTo("office");
    }

    function confirmResign() {
      renderFired("Você decidiu deixar Valley City por vontade própria. Seus registros permanecem arquivados, mas sua jornada aqui terminou.");
    }

    // ---------- EXPOR FUNÇÕES ----------
    window.goTo = goTo;
    window.saveGameToFile = saveGameToFile;
    window.handleFileLoad = handleFileLoad;
    window.setAvatar = setAvatar;
    window.startNewGame = startNewGame;
    window.openWitness = openWitness;
    window.askWitness = askWitness;
    window.askWitnessFree = askWitnessFree;
    window.openSuspect = openSuspect;
    window.askSuspectTemplate = askSuspectTemplate;
    window.askSuspect = askSuspect;
    window.finalizeCase = finalizeCase;
    window.callChief = callChief;
    window.callForensics = callForensics;
    window.callStreet = callStreet;
    window.finishPromotionExam = finishPromotionExam;
    window.confirmResign = confirmResign;

    // ---------- INICIALIZAÇÃO ----------
    window.addEventListener("load", function() {
      ensureGameState();
      goTo("start");
    });
  </script>
</body>
</html>
