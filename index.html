<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Valley City • Crime Unit</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <style>
    :root {
      --bg-main: #05070d;
      --bg-card: #111524;
      --bg-card-soft: #161a2b;
      --accent: #ffb321;
      --accent-soft: #ffdd7a;
      --text-main: #f5f7ff;
      --text-soft: #a0a7c4;
      --danger: #ff4d4d;
      --success: #30d178;
      --warning: #ffb648;
      --radius-lg: 20px;
      --radius-md: 14px;
      --transition-fast: 0.18s ease-out;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      background: #000;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      margin: 0 auto;
      position: relative;
      background: transparent;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .screen {
      display: none;
      padding: 20px 18px 26px;
      min-height: 100vh;
      position: relative;
      background-color: #05070d;       /* fallback */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .screen.active {
      display: block;
      /* removido o fadeIn para não dar efeito de "piscar" */
    }

    /* FUNDOS DAS TELAS - USANDO ASSETS DIRETO */

    #screen-start {
      background-image: url("assets/capa_principal.png");
    }

    #screen-login {
      background-image: url("assets/bg_login.png");
    }

    #screen-avatar {
      background-image: url("assets/police_station_front.png");
    }

    #screen-briefing {
      background-image: url("assets/captain_room_cinematic.png");
    }

    #screen-office {
      background-image: url("assets/escritorio_detective.png");
    }

    #screen-phone {
      background-image: url("assets/phone_interface.png");
    }

    #screen-promotion {
      background-image: url("assets/promotion_bg.png");
    }

    #screen-stats {
      background-image: url("assets/valley_city_night.png");
    }

    #screen-case {
      background-image: url("assets/case_scene_bg.png");
    }

    #screen-witnesses {
      background-image: url("assets/witness_room.png");
    }

    #screen-evidence {
      background-image: url("assets/evidence_room.png");
    }

    #screen-suspects {
      background-image: url("assets/suspect_file_bg.png");
    }

    #screen-interrogation {
      background-image: url("assets/interrogation_room.png");
    }

    #screen-iml {
      background-image: url("assets/morgue_room.png");
    }

    #screen-conclude {
      background-image: url("assets/crime_scene_01.png");
    }

    #screen-fired {
      background-image: url("assets/fired_screen.png");
    }

    header.topline {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-soft);
      margin-bottom: 6px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.75);
    }

    h1.title {
      font-size: 28px;
      text-transform: uppercase;
      margin-bottom: 16px;
      letter-spacing: 0.12em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    h2.subtitle {
      font-size: 20px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    p {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .card {
      background: radial-gradient(circle at top left,
                  rgba(20, 26, 54, 0.92) 0,
                  rgba(6, 8, 18, 0.92) 60%);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      margin-bottom: 14px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(6px);
    }

    .card-soft {
      background: rgba(6, 8, 18, 0.88);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(4px);
    }

    .btn {
      width: 100%;
      border-radius: 999px;
      padding: 13px 16px;
      border: none;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 8px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast), opacity var(--transition-fast);
      font-weight: 600;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffb321, #ffdf7a);
      color: #22130a;
      box-shadow: 0 12px 26px rgba(255, 179, 33, 0.45);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 20px rgba(255, 179, 33, 0.35);
    }

    .btn-outline {
      background: rgba(7, 10, 22, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-outline:active {
      transform: translateY(1px) scale(0.99);
      background: rgba(20, 25, 40, 0.98);
    }

    .btn-danger {
      background: rgba(198, 59, 59, 0.18);
      color: var(--danger);
      border: 1px solid rgba(255, 77, 77, 0.55);
    }

    small {
      font-size: 11px;
      color: var(--text-soft);
    }

    .hint {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .avatar-list {
      margin-top: 12px;
    }

    .avatar-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: rgba(9, 12, 24, 0.96);
      margin-bottom: 8px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: border var(--transition-fast), background var(--transition-fast);
      backdrop-filter: blur(4px);
    }

    .avatar-item img {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      object-fit: cover;
      margin-right: 10px;
    }

    .avatar-info {
      flex: 1;
    }

    .avatar-name {
      font-size: 14px;
      font-weight: 600;
    }

    .avatar-desc {
      font-size: 12px;
      color: var(--text-soft);
    }

    .avatar-item.selected {
      border-color: var(--accent-soft);
      background: radial-gradient(circle at top left, #2a3250 0, #050712 75%);
    }

    .office-layout {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }

    .office-left {
      width: 80px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .office-avatar {
      width: 72px;
      height: 72px;
      border-radius: 22px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.85);
    }

    .office-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tag-pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.09);
      color: var(--text-soft);
      backdrop-filter: blur(4px);
    }

    .office-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .label {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-bottom: 2px;
    }

    .value-main {
      font-size: 14px;
      font-weight: 600;
    }

    .bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.09);
      overflow: hidden;
      margin-top: 4px;
    }

    .bar-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ffb321, #30d178);
      transition: width 0.3s ease-out;
    }

    .bar-inner.warning {
      background: linear-gradient(90deg, #ffb321, #ff4d4d);
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .stat-text {
      font-size: 13px;
      color: var(--text-soft);
    }

    .stat-number {
      font-size: 13px;
      font-weight: 600;
    }

    .rules-box {
      margin-top: 14px;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(5, 7, 16, 0.94);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 12px;
      backdrop-filter: blur(6px);
    }

    .rules-title {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      color: var(--accent-soft);
    }

    .rules-title span {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 179, 33, 0.8);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-soft);
      backdrop-filter: blur(3px);
    }

    .case-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .badge {
      display: inline-block;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      background: rgba(255, 255, 255, 0.15);
      margin-bottom: 8px;
      backdrop-filter: blur(4px);
    }

    .list {
      margin-top: 8px;
      max-height: 340px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .list-item {
      border-radius: 12px;
      padding: 10px 11px;
      background: rgba(7, 10, 20, 0.94);
      margin-bottom: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
      transition: background var(--transition-fast), border var(--transition-fast);
      backdrop-filter: blur(3px);
    }

    .list-item:hover {
      background: rgba(17, 21, 35, 0.98);
      border-color: rgba(255, 255, 255, 0.18);
    }

    .list-item.selected {
      border-color: var(--accent-soft);
      background: radial-gradient(circle at top left, #2a3250 0, #0b0f1c 70%);
    }

    .list-item h4 {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .list-item p {
      font-size: 12px;
      margin-bottom: 0;
    }

    .typewriter {
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2, 4, 10, 0.94);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 13px;
      min-height: 70px;
      white-space: pre-wrap;
      backdrop-filter: blur(3px);
    }

    .pill-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .q-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .q-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(8, 10, 20, 0.96);
      padding: 5px 8px;
      font-size: 11px;
      text-align: center;
      color: var(--text-soft);
      cursor: pointer;
      backdrop-filter: blur(3px);
    }

    .q-btn:active {
      background: rgba(20, 25, 40, 0.98);
    }

    .input-text {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 10px 12px;
      background: rgba(4, 6, 14, 0.96);
      color: var(--text-main);
      font-size: 13px;
      margin-top: 8px;
      outline: none;
    }

    .input-text::placeholder {
      color: rgba(160, 167, 196, 0.7);
    }

    .tag-danger {
      color: var(--danger);
    }

    .tag-success {
      color: var(--success);
    }

    .center {
      text-align: center;
    }

    .mt-4 { margin-top: 4px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }

    .small-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .file-input {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .iml-header {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .iml-photo {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .iml-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tag-iml {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      color: var(--text-soft);
    }

    .danger-text {
      color: var(--danger);
      font-size: 13px;
    }

    .badge-rank {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--accent-soft);
      backdrop-filter: blur(3px);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- START -->
    <section id="screen-start" class="screen active">
      <header class="topline">Valley City • Crime Unit</header>
      <h1 class="title">Início</h1>
      <div class="card">
        <p>
          Bem-vindo a Valley City. Uma cidade violenta, poucos policiais e crimes
          demais. O distrito precisa de um detetive com nervos de aço... ou
          alguém disposto a quebrá-los.
        </p>
        <p class="hint">
          Seu progresso é salvo localmente neste dispositivo. Você poderá exportar
          e importar seu arquivo de jogo em formato JSON para continuar em outro
          aparelho.
        </p>
        <button class="btn btn-primary mt-8" onclick="goTo('login')">
          Iniciar / Carregar Jogo
        </button>
      </div>
    </section>

    <!-- LOGIN / SAVE -->
    <section id="screen-login" class="screen">
      <header class="topline">Valley City • Sistema de Arquivos</header>
      <h1 class="title">Carregar / Salvar</h1>
      <div class="card">
        <p>
          Você pode começar um novo jogo ou carregar um arquivo JSON salvo
          anteriormente. Todo progresso fica guardado neste aparelho, sem conexão
          com servidores externos.
        </p>
        <button class="btn btn-primary mt-8" onclick="startNewGame()">
          Novo Jogo
        </button>
        <div class="mt-12">
          <div class="small-label">Importar arquivo de save (.json)</div>
          <input
            id="import-file"
            type="file"
            accept="application/json"
            class="file-input"
            onchange="handleImportFile(event)"
          />
        </div>
        <button class="btn btn-outline mt-8" onclick="loadFromLocalStorage()">
          Carregar último jogo deste dispositivo
        </button>
        <button class="btn btn-outline mt-8" onclick="goTo('start')">
          Voltar
        </button>
      </div>
    </section>

    <!-- AVATAR -->
    <section id="screen-avatar" class="screen">
      <header class="topline">Perfil do Agente</header>
      <h1 class="title">Escolha seu Avatar</h1>
      <p>
        Selecione um dos agentes disponíveis. Este avatar representará você nos
        dossiês e telas de status.
      </p>
      <div id="avatar-list" class="avatar-list"></div>
      <button class="btn btn-primary mt-8" onclick="confirmAvatar()">
        Continuar
      </button>
      <button class="btn btn-outline mt-4" onclick="goTo('login')">
        Voltar
      </button>
    </section>

    <!-- BRIEFING -->
    <section id="screen-briefing" class="screen">
      <header class="topline">Distrito Policial • Valley City</header>
      <h1 class="title">Briefing do Capitão</h1>
      <div class="card">
        <p>
          “Valley City não é lugar para amadores. Aqui a violência é o idioma
          local, e a gente fala na mesma altura. Você foi designado para este
          distrito porque alguém acha que você pode fazer a diferença.”
        </p>
        <p>
          “Nós temos poucos policiais, muitos crimes e quase nenhuma segunda
          chance. Você vai receber casos um por vez, com acesso a documentos,
          perícia, testemunhas e suspeitos. Use o que tiver. Se errar demais, vai
          para a rua.”
        </p>
        <p>
          “Não pise na bola. Se fizer um bom trabalho, promoções podem te levar
          para o FBI... talvez até para a CIA. Mas se estragar tudo, eu mesmo
          assino sua demissão. Boa sorte, detetive. Você vai precisar.”
        </p>
        <button class="btn btn-primary mt-12" onclick="goTo('office')">
          Entendido, chefe
        </button>
      </div>
    </section>

    <!-- OFFICE -->
    <section id="screen-office" class="screen">
      <header class="topline">Valley City • Unidade de Investigação</header>
      <h1 class="title">Escritório do Detetive</h1>

      <div class="office-layout">
        <div class="office-left">
          <div class="office-avatar">
            <img id="office-avatar-img" src="assets/avatar_01.png" alt="Avatar" />
          </div>
          <div class="tag-pill" id="office-agency-tag">Detetive • VCPD</div>
        </div>
        <div class="office-right">
          <div class="card-soft">
            <div class="label">Cargo Atual</div>
            <div class="value-main" id="office-rank">Detetive Júnior • VCPD</div>
            <div class="label mt-4">Prestígio Interno</div>
            <div class="bar">
              <div id="bar-prestigio-interno" class="bar-inner"></div>
            </div>
          </div>
          <div class="card-soft">
            <div class="row">
              <div>
                <div class="label">Casos Resolvidos</div>
                <div class="value-main" id="office-casos">0 / 0</div>
              </div>
              <div class="label" style="text-align:right;">Reputação Pública</div>
            </div>
            <div class="bar">
              <div id="bar-prestigio-publico" class="bar-inner warning"></div>
            </div>
          </div>
          <div class="card-soft">
            <div class="label">Skills</div>
            <div class="row">
              <div class="stat-text" id="office-skills">Intuição 1 • Forense 1</div>
              <div class="stat-number" id="office-xp">0 pts</div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="openNextCase()">Próximo Caso</button>
      <button class="btn btn-outline" onclick="openPhone()">Telefonar</button>
      <button class="btn btn-outline" onclick="openPromotion()">Pedir Promoção</button>
      <button class="btn btn-outline" onclick="openStats()">Histórico / Estatísticas</button>
      <button class="btn btn-outline" onclick="saveGame(true)">Salvar Agora</button>
      <button class="btn btn-outline" onclick="goTo('start')">Sair para Menu</button>

      <div class="rules-box">
        <div class="rules-title">
          <span>Regras</span>
        </div>
        <p>
          Três erros começam a gerar advertências. Acima de seis advertências, sua
          carreira neste distrito termina. Prestígio e reputação sobem com casos
          resolvidos e caem com acusações erradas.
        </p>
      </div>
    </section>

    <!-- PHONE -->
    <section id="screen-phone" class="screen">
      <header class="topline">Valley City • Linha Segura</header>
      <h1 class="title">Telefone do Distrito</h1>
      <div class="card">
        <p>Escolha para quem deseja ligar.</p>
        <div class="list">
          <div class="list-item" onclick="callChief()">
            <h4>Chefe de Polícia</h4>
            <p>Discutir desempenho, pedir desculpas, elogiar equipe ou pedir demissão.</p>
          </div>
          <div class="list-item" onclick="callForensics()">
            <h4>Perito Legista / Forense</h4>
            <p>Solicitar detalhes adicionais do laudo ou esclarecimentos técnicos.</p>
          </div>
          <div class="list-item" onclick="callStreetUnit()">
            <h4>Equipe de Rua</h4>
            <p>Acionar patrulha para mandado de busca ou condução de suspeitos.</p>
          </div>
        </div>
        <button class="btn btn-outline mt-8" onclick="goTo('office')">
          Voltar ao Escritório
        </button>
      </div>
    </section>

    <!-- PROMOTION -->
    <section id="screen-promotion" class="screen">
      <header class="topline">Valley City • Comissão de Carreira</header>
      <h1 class="title">Pedido de Promoção</h1>
      <div class="card">
        <p id="promotion-text">
          Para se candidatar à próxima patente, você precisa de prestígio interno
          mínimo de 80% e bom histórico de acertos.
        </p>
        <button class="btn btn-primary mt-8" onclick="startPromotionExam()">
          Iniciar Prova (10 questões)
        </button>
        <button class="btn btn-outline mt-8" onclick="goTo('office')">
          Voltar ao Escritório
        </button>
      </div>
    </section>

    <!-- STATS -->
    <section id="screen-stats" class="screen">
      <header class="topline">Valley City • Dossiê do Agente</header>
      <h1 class="title">Histórico & Estatísticas</h1>
      <div class="card">
        <div class="row">
          <div class="stat-text">Casos Concluídos</div>
          <div class="stat-number" id="stats-cases">0</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Acusações Corretas</div>
          <div class="stat-number tag-success" id="stats-correct">0</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Acusações Erradas</div>
          <div class="stat-number tag-danger" id="stats-wrong">0</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Advertências</div>
          <div class="stat-number tag-danger" id="stats-warnings">0</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Prestígio Interno</div>
          <div class="stat-number" id="stats-prestigio-int">0%</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Reputação Pública</div>
          <div class="stat-number" id="stats-prestigio-pub">0%</div>
        </div>
        <div class="row mt-4">
          <div class="stat-text">Agência Atual</div>
          <div class="stat-number" id="stats-agency">VCPD</div>
        </div>
        <button class="btn btn-outline mt-12" onclick="goTo('office')">
          Voltar ao Escritório
        </button>
      </div>
    </section>

    <!-- CASE SCREEN -->
    <section id="screen-case" class="screen">
      <header class="topline">Valley City • Caso Ativo</header>
      <h1 class="title" id="case-title">Caso</h1>
      <div class="card">
        <div class="badge" id="case-badge">Nível • Desconhecido</div>
        <div class="case-title" id="case-name">Nome do Caso</div>
        <p id="case-description">Descrição do caso em andamento.</p>

        <div class="chip-row">
          <div class="chip" id="chip-dificuldade">Dificuldade: —</div>
          <div class="chip" id="chip-tipo">Tipo: —</div>
          <div class="chip" id="chip-objetivo">Objetivo: Encontrar culpado</div>
        </div>

        <button class="btn btn-primary mt-8" onclick="openWitnesses()">
          Testemunhas
        </button>
        <button class="btn btn-outline" onclick="openEvidence()">
          Provas & Perícia
        </button>
        <button class="btn btn-outline" onclick="openSuspects()">
          Suspeitos & Dossiês
        </button>
        <button class="btn btn-danger" onclick="openConcludeCase()">
          Concluir Caso (Indicar Culpado)
        </button>
        <button class="btn btn-outline mt-4" onclick="goTo('office')">
          Voltar ao Escritório
        </button>
      </div>
    </section>

    <!-- WITNESSES -->
    <section id="screen-witnesses" class="screen">
      <header class="topline">Valley City • Depoimentos</header>
      <h1 class="title">Testemunhas</h1>
      <div class="card">
        <div class="row">
          <div class="stat-text">Caso Ativo</div>
          <div class="badge-rank" id="witness-case-name">—</div>
        </div>
        <div class="list" id="witness-list"></div>
        <div class="pill-label mt-8">Depoimento</div>
        <div id="witness-statement" class="typewriter">
          Selecione uma testemunha para ouvir o depoimento.
        </div>
        <div class="pill-label mt-8">Perguntas rápidas</div>
        <div class="q-grid" id="witness-quick-questions"></div>
        <button class="btn btn-outline mt-12" onclick="goTo('case')">
          Voltar ao Caso
        </button>
      </div>
    </section>

    <!-- EVIDENCE -->
    <section id="screen-evidence" class="screen">
      <header class="topline">Valley City • Setor de Provas</header>
      <h1 class="title">Provas & Perícia</h1>
      <div class="card">
        <div class="badge" id="evidence-case-name">Caso Atual</div>
        <div class="list" id="evidence-list"></div>
        <button class="btn btn-outline mt-8" onclick="openIMLIfAvailable()">
          Ver Laudo do Perito (IML)
        </button>
        <button class="btn btn-outline mt-8" onclick="goTo('case')">
          Voltar ao Caso
        </button>
      </div>
    </section>

    <!-- SUSPECTS -->
    <section id="screen-suspects" class="screen">
      <header class="topline">Valley City • Arquivo de Suspeitos</header>
      <h1 class="title">Suspeitos</h1>
      <div class="card">
        <div class="badge" id="suspects-case-name">Caso Atual</div>
        <div class="list" id="suspects-list"></div>
        <button class="btn btn-outline mt-8" onclick="goTo('case')">
          Voltar ao Caso
        </button>
      </div>
    </section>

    <!-- INTERROGATION -->
    <section id="screen-interrogation" class="screen">
      <header class="topline">Valley City • Sala de Interrogatório</header>
      <h1 class="title" id="interrogation-title">Interrogatório</h1>
      <div class="card">
        <div class="row">
          <div class="stat-text" id="interrogation-suspect-label">Suspeito</div>
          <div class="badge-rank" id="interrogation-case-label">Caso Atual</div>
        </div>
        <div class="typewriter mt-8" id="interrogation-log">
          Comece fazendo perguntas. O suspeito responderá com base no álibi e
          no perfil registrado.
        </div>
        <input
          id="interrogation-input"
          class="input-text"
          type="text"
          placeholder="Digite sua pergunta aqui..."
          onkeydown="if(event.key==='Enter'){sendInterrogationQuestion();}"
        />
        <button class="btn btn-primary mt-8" onclick="sendInterrogationQuestion()">
          Perguntar
        </button>
        <div class="pill-label mt-8">Sugestões de perguntas</div>
        <div class="q-grid" id="interrogation-suggestions"></div>
        <button class="btn btn-outline mt-12" onclick="goTo('suspects')">
          Voltar aos Suspeitos
        </button>
      </div>
    </section>

    <!-- IML -->
    <section id="screen-iml" class="screen">
      <header class="topline">Valley City • Instituto Médico Legal</header>
      <h1 class="title">Laudo do Perito</h1>
      <div class="card">
        <div class="iml-header">
          <div class="iml-photo">
            <img src="assets/perito_legista.png" alt="Perito Legista" />
          </div>
          <div>
            <div class="tag-iml">Dr. Collins • Perito Legista</div>
            <p class="mt-4">
              Análise técnica do corpo da vítima, horário provável da morte,
              tipo de arma utilizada e demais observações forenses.
            </p>
          </div>
        </div>
        <div id="iml-report-text" class="typewriter">
          Nenhum laudo carregado. Abra um caso com vítima fatal para visualizar
          o relatório detalhado.
        </div>
        <button class="btn btn-outline mt-12" onclick="goTo('evidence')">
          Voltar às Provas
        </button>
      </div>
    </section>

    <!-- CONCLUDE CASE -->
    <section id="screen-conclude" class="screen">
      <header class="topline">Valley City • Encerramento de Caso</header>
      <h1 class="title">Indicar Culpado</h1>
      <div class="card">
        <p>
          Escolha um suspeito para acusar formalmente. Se estiver errado, sua
          reputação e prestígio serão afetados, e advertências podem ser geradas.
        </p>
        <div class="list" id="conclude-suspects-list"></div>
        <button class="btn btn-outline mt-8" onclick="goTo('case')">
          Voltar ao Caso
        </button>
      </div>
    </section>

    <!-- FIRED -->
    <section id="screen-fired" class="screen">
      <header class="topline">Valley City • Recursos Humanos</header>
      <h1 class="title">Você foi demitido</h1>
      <div class="card">
        <p class="danger-text">
          O excesso de erros e advertências comprometeu a confiança do distrito
          no seu trabalho. Seu crachá foi recolhido e seu acesso aos casos
          encerrado.
        </p>
        <p class="mt-8">
          Você pode iniciar uma nova carreira em Valley City, desta vez com mais
          cuidado nas investigações.
        </p>
        <button class="btn btn-primary mt-12" onclick="startNewGame()">
          Recomeçar do Zero
        </button>
        <button class="btn btn-outline mt-8" onclick="goTo('start')">
          Voltar ao Início
        </button>
      </div>
    </section>
  </div>

  <script>
    // ---------- CONSTANTES / ESTADO ----------
    const AVATARS = [
      "avatar_01",
      "avatar_02",
      "avatar_03",
      "avatar_04",
      "avatar_05",
      "avatar_06",
      "avatar_07",
      "avatar_08",
      "avatar_09",
      "avatar_10"
    ];

    const BG_IMAGES = [
      "assets/capa_principal.png",
      "assets/bg_login.png",
      "assets/police_station_front.png",
      "assets/captain_room_cinematic.png",
      "assets/escritorio_detective.png",
      "assets/phone_interface.png",
      "assets/promotion_bg.png",
      "assets/valley_city_night.png",
      "assets/case_scene_bg.png",
      "assets/witness_room.png",
      "assets/evidence_room.png",
      "assets/suspect_file_bg.png",
      "assets/interrogation_room.png",
      "assets/morgue_room.png",
      "assets/crime_scene_01.png",
      "assets/fired_screen.png"
    ];

    const QUICK_QUESTIONS_WITNESS = [
      "Onde você estava no momento do crime?",
      "Você conhecia a vítima?",
      "Você viu alguém fugir da cena?",
      "Consegue descrever algum veículo?",
      "Percebeu algo estranho nos dias anteriores?",
      "Sabe se a vítima tinha inimigos?",
      "Ouviu algum barulho ou discussão?",
      "Tem mais alguma informação importante?"
    ];

    const INTERROGATION_QUESTIONS = [
      "Onde você estava no momento do crime?",
      "Alguém pode confirmar seu álibi?",
      "Qual é sua relação com a vítima?",
      "Você já discutiu com a vítima?",
      "Por que seu nome apareceu na investigação?",
      "Você possui antecedentes criminais?",
      "Como explica as provas encontradas?",
      "Conhece alguém que queira incriminar você?",
      "Estava armado naquela noite?",
      "Quando viu a vítima pela última vez?",
      "Você sabia da rotina da vítima?",
      "Tem alguma dívida com a vítima?",
      "Por que não procurou a polícia antes?",
      "O que você faria no lugar da vítima?",
      "Há algo que ainda não nos contou?",
      "Você entrou no local do crime?",
      "Conhece os outros suspeitos?",
      "Por que seu veículo foi visto próximo ao local?",
      "Alguma vez esteve no motel da rodovia?",
      "Você ameaçou a vítima recentemente?",
      "Tem acesso à arma compatível com o crime?",
      "Quanto tempo conhece a vítima?",
      "Você lucra de alguma forma com a morte dela?",
      "Alguém pediu para você mentir aqui?",
      "Você alterou sua versão dos fatos?",
      "Por que seu álibi é tão confuso?",
      "Onde estava seu celular no horário do crime?",
      "Deixou a cidade nos dias seguintes?",
      "Tem algo a declarar em sua defesa?",
      "Você gostaria de acrescentar mais algum detalhe?"
    ];

    const CASES = [
      {
        id: "case1",
        name: "Homicídio no Motel da Rodovia",
        level: "Júnior",
        difficulty: "Alta",
        type: "Homicídio",
        needsIML: true,
        description:
          "Um empresário foi encontrado morto em um quarto de motel na saída leste de Valley City. A cena indica possível crime passional, mas há sinais de algo mais planejado.",
        witnesses: [
          {
            id: "w1",
            name: "Atendente do Motel",
            relation: "Funcionária do turno",
            portrait: "witness_01",
            statement:
              "O casal entrou por volta das 21h30. Pareciam discutindo baixo, mas nada muito agressivo. Depois disso, não vi mais ninguém entrar ou sair pelo corredor.",
            qa: [
              {
                keywords: ["onde", "estava", "momento"],
                answer:
                  "Eu estava na recepção conferindo reservas e câmeras do saguão."
              },
              {
                keywords: ["conhecia", "vítima", "vitima"],
                answer:
                  "Não, nunca tinha visto ele antes. Mas ela já veio outras vezes."
              }
            ]
          },
          {
            id: "w2",
            name: "Camareira",
            relation: "Equipe de limpeza",
            portrait: "witness_03",
            statement:
              "Eu ia começar a limpar o corredor daquele andar quando vi a porta entreaberta. Chamei, ninguém respondeu. Quando empurrei, ele já estava caído.",
            qa: [
              {
                keywords: ["hora", "que horas", "horário"],
                answer:
                  "Isso foi perto das 23h10. Eu sigo sempre o mesmo cronograma de limpeza."
              }
            ]
          },
          {
            id: "w3",
            name: "Hóspede do Quarto ao Lado",
            relation: "Hóspede",
            portrait: "witness_05",
            statement:
              "Ouvi uma discussão aumentando de tom, uns 20 minutos depois de eles entrarem. Parecia que alguém bateu na mesa ou jogou algo no chão.",
            qa: [
              {
                keywords: ["barulho", "ruído", "som"],
                answer:
                  "Ouvi algo como um objeto pesado caindo, talvez uma cadeira ou mala."
              },
              {
                keywords: ["viu", "porta"],
                answer:
                  "Não abri a porta. Só aumentei o volume da TV para tentar ignorar."
              }
            ]
          },
          {
            id: "w4",
            name: "Vizinho de Loja",
            relation: "Dono de posto próximo",
            portrait: "witness_06",
            statement:
              "Eu vi um carro prata parado perto da entrada lateral do motel. Parecia alguém esperando dentro, com o farol apagado.",
            qa: [
              {
                keywords: ["placa"],
                answer:
                  "Não consegui ver a placa, estava distante e com pouca luz."
              },
              {
                keywords: ["horário"],
                answer:
                  "Isso foi um pouco depois das 22h. Eu estava fechando o caixa do posto."
              }
            ]
          },
          {
            id: "w5",
            name: "Funcionário da Portaria",
            relation: "Segurança",
            portrait: "witness_11",
            statement:
              "Ninguém registrou saída pelo saguão principal naquele horário. Se alguém saiu, pode ter usado a saída de serviço.",
            qa: [
              {
                keywords: ["câmera", "camera"],
                answer:
                  "As câmeras da saída de serviço estavam com interferência de sinal naquela noite."
              }
            ]
          }
        ],
        evidence: [
          {
            id: "e1",
            type: "Documento",
            name: "Registro de Check-in",
            description:
              "Ficha de entrada com nome falso usado pelo empresário, horário de 21h28 e pagamento em dinheiro.",
            image: "evidence_doc_01"
          },
          {
            id: "e2",
            type: "Objeto",
            name: "Copo de Whisky Quebrado",
            description:
              "Copo estilhaçado próximo ao corpo, com impressões parciais da vítima e de uma segunda pessoa.",
            image: "evidence_obj_01"
          },
          {
            id: "e3",
            type: "Arma",
            name: "Objeto Contundente Não Encontrado",
            description:
              "Marca de impacto na região occipital indica uso de objeto pesado e alongado, possivelmente um abajur ou barra de ferro.",
            image: "evidence_weapon_01"
          }
        ],
        imlReport:
          "Homem, 46 anos. Tempo estimado de morte: entre 22h30 e 23h. Causa provável: traumatismo craniano por objeto contundente. Há marcas de defesa nos antebraços, indicando reação à agressão. Vestígios de álcool no sangue, porém em nível moderado.",
        suspects: [
          {
            id: "s1",
            name: "Larissa M.",
            portrait: "suspect_01",
            age: 32,
            occupation: "Advogada",
            relation: "Acompanhante no motel",
            criminalRecord: "Sem antecedentes criminais registrados.",
            address: "Bairro central, apartamento de médio padrão.",
            alibi:
              "Afirma ter deixado o quarto após uma discussão, por volta das 22h15, e voltado de táxi para casa.",
            profileNotes:
              "Histórico de relacionamento conturbado com a vítima. Troca de mensagens mostra ciúme e ameaças veladas.",
            keywordsAnswers: [
              {
                keywords: ["onde", "estava", "momento"],
                answer:
                  "Eu já estava em casa quando isso aconteceu. Saí do motel bem antes, ele ainda estava vivo."
              },
              {
                keywords: ["táxi", "taxi"],
                answer:
                  "Peguei um táxi na porta do motel. O motorista deve lembrar, eu estava chorando."
              },
              {
                keywords: ["motivo", "briga", "discussão"],
                answer:
                  "A discussão foi por causa de uma mentira que ele me contou. Mas eu nunca faria isso."
              }
            ],
            isGuilty: false
          },
          {
            id: "s2",
            name: "Marcos A.",
            portrait: "suspect_02",
            age: 41,
            occupation: "Sócio de Negócios",
            relation: "Sócio em empresa de logística",
            criminalRecord:
              "Envolvimento anterior em fraude tributária, processo arquivado.",
            address: "Condomínio fechado na zona norte.",
            alibi:
              "Diz que estava em uma reunião informal com clientes em um bar do centro, até depois das 23h.",
            profileNotes:
              "Tinha divergências financeiras com a vítima. E-mails revelam ameaças indiretas sobre 'acertar contas'.",
            keywordsAnswers: [
              {
                keywords: ["onde", "estava", "momento"],
                answer:
                  "Eu estava no bar com dois clientes. Eles podem confirmar cada minuto daquela noite."
              },
              {
                keywords: ["dinheiro", "dívida", "divida"],
                answer:
                  "Tínhamos desentendimentos, sim, mas isso é normal em negócios. Não sou assassino."
              },
              {
                keywords: ["motet", "motel", "rodovia"],
                answer:
                  "Eu nem sabia que ele ia para esse motel. Isso não tem nada a ver comigo."
              }
            ],
            isGuilty: true
          },
          {
            id: "s3",
            name: "Bruna C.",
            portrait: "suspect_03",
            age: 29,
            occupation: "Recepcionista de Hotel",
            relation: "Ex-namorada",
            criminalRecord: "Nenhum registro criminal.",
            address: "Bairro residencial de classe média.",
            alibi:
              "Afirma estar trabalhando em turno da noite em outro hotel da cidade.",
            profileNotes:
              "Término recente e mensagens carregadas de mágoa. Mas não há evidência direta ligando-a ao motel.",
            keywordsAnswers: [
              {
                keywords: ["onde", "estava", "momento"],
                answer:
                  "Eu estava no balcão do hotel onde trabalho. Tem câmeras, colegas, tudo."
              },
              {
                keywords: ["motel"],
                answer:
                  "Se eu soubesse que ele estava num motel naquela noite, teria ficado ainda mais decepcionada, mas não fui atrás."
              }
            ],
            isGuilty: false
          }
        ]
      }
    ];

    const INITIAL_STATE = {
      avatarIndex: 0,
      rank: "Detetive Júnior",
      agency: "VCPD",
      prestigioInterno: 10,
      prestigioPublico: 5,
      xp: 0,
      skills: { intuicao: 1, forense: 1 },
      casesSolved: 0,
      casesTotal: 0,
      correctAccusations: 0,
      wrongAccusations: 0,
      warnings: 0,
      fired: false,
      currentCaseIndex: null
    };

    let state = JSON.parse(JSON.stringify(INITIAL_STATE));
    let currentWitnessTypingTimeout = null;
    let currentWitness = null;
    let currentInterrogationSuspect = null;

    // ---------- PRELOAD ----------
    function preloadImages(paths) {
      paths.forEach((p) => {
        const img = new Image();
        img.src = p;
      });
    }

    // ---------- NAVEGAÇÃO ----------
    function goTo(id) {
      const current = document.querySelector(".screen.active");
      const next = document.getElementById("screen-" + id);

      // Primeiro ativa a próxima tela, depois desativa a atual
      if (next && !next.classList.contains("active")) {
        next.classList.add("active");
      }
      if (current && current !== next) {
        current.classList.remove("active");
      }

      if (id === "office") renderOffice();
      if (id === "stats") renderStats();
    }

    // ---------- AVATAR ----------
    function initAvatarScreen() {
      const container = document.getElementById("avatar-list");
      container.innerHTML = "";
      AVATARS.forEach((key, i) => {
        const item = document.createElement("div");
        item.className = "avatar-item" + (i === state.avatarIndex ? " selected" : "");
        item.dataset.index = i;
        item.onclick = () => {
          state.avatarIndex = i;
          initAvatarScreen();
        };
        const img = document.createElement("img");
        img.src = "assets/" + key + ".png";
        img.alt = "Avatar " + (i + 1);
        const info = document.createElement("div");
        info.className = "avatar-info";
        const name = document.createElement("div");
        name.className = "avatar-name";
        name.textContent = "Agente " + (i + 1);
        const desc = document.createElement("div");
        desc.className = "avatar-desc";
        desc.textContent = "Toque para selecionar este avatar.";
        info.appendChild(name);
        info.appendChild(desc);
        item.appendChild(img);
        item.appendChild(info);
        container.appendChild(item);
      });
    }

    function confirmAvatar() {
      goTo("briefing");
      updateOfficeAvatar();
    }

    function updateOfficeAvatar() {
      const img = document.getElementById("office-avatar-img");
      if (img) {
        img.src = "assets/" + AVATARS[state.avatarIndex] + ".png";
      }
    }

    // ---------- ESCRITÓRIO / STATS ----------
    function renderOffice() {
      updateOfficeAvatar();
      document.getElementById("office-rank").textContent =
        state.rank + " • " + state.agency;
      document.getElementById("office-agency-tag").textContent =
        state.agency === "VCPD"
          ? "Detetive • VCPD"
          : state.agency === "FBI"
          ? "Agente Federal • FBI"
          : "Agente Especial • CIA";
      document.getElementById("office-casos").textContent =
        state.casesSolved + " / " + state.casesTotal;
      document.getElementById("office-skills").textContent =
        "Intuição " + state.skills.intuicao + " • Forense " + state.skills.forense;
      document.getElementById("office-xp").textContent = state.xp + " pts";

      const intBar = document.getElementById("bar-prestigio-interno");
      const pubBar = document.getElementById("bar-prestigio-publico");
      intBar.style.width = Math.min(state.prestigioInterno, 100) + "%";
      pubBar.style.width = Math.min(state.prestigioPublico, 100) + "%";

      if (state.warnings >= 6 && !state.fired) {
        state.fired = true;
        saveGame();
        goTo("fired");
      }
    }

    function renderStats() {
      document.getElementById("stats-cases").textContent = state.casesSolved;
      document.getElementById("stats-correct").textContent =
        state.correctAccusations;
      document.getElementById("stats-wrong").textContent =
        state.wrongAccusations;
      document.getElementById("stats-warnings").textContent = state.warnings;
      document.getElementById(
        "stats-prestigio-int"
      ).textContent = state.prestigioInterno + "%";
      document.getElementById(
        "stats-prestigio-pub"
      ).textContent = state.prestigioPublico + "%";
      document.getElementById("stats-agency").textContent = state.agency;
    }

    // ---------- SAVE / LOAD ----------
    function saveGame(showAlert) {
      const data = JSON.stringify(state);
      localStorage.setItem("valleyCitySave", data);
      if (showAlert) alert("Jogo salvo localmente com sucesso.");
    }

    function loadFromLocalStorage() {
      const raw = localStorage.getItem("valleyCitySave");
      if (!raw) {
        alert("Nenhum save local encontrado.");
        return;
      }
      try {
        state = JSON.parse(raw);
        goTo("office");
      } catch (e) {
        alert("Erro ao carregar save.");
      }
    }

    function startNewGame() {
      state = JSON.parse(JSON.stringify(INITIAL_STATE));
      state.casesTotal = CASES.length;
      initAvatarScreen();
      goTo("avatar");
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          state = data;
          alert("Save importado com sucesso.");
          goTo("office");
        } catch (err) {
          alert("Arquivo JSON inválido.");
        }
      };
      reader.readAsText(file);
    }

    // ---------- PHONE ----------
    function openPhone() {
      goTo("phone");
    }

    function callChief() {
      const choice = prompt(
        "Chefe de Polícia na linha:\n\n1 - Pedir demissão\n2 - Pedir desculpas\n3 - Elogiar equipe\n4 - Elogiar o chefe\n\nDigite o número da opção:"
      );
      if (!choice) return;
      switch (choice.trim()) {
        case "1":
          if (confirm("Tem certeza que deseja se demitir?")) {
            state = JSON.parse(JSON.stringify(INITIAL_STATE));
            alert("Você deixou o cargo. Inicie uma nova carreira.");
            goTo("start");
          }
          break;
        case "2":
          state.prestigioInterno = Math.min(100, state.prestigioInterno + 4);
          alert("Você reconheceu seus erros. Prestígio interno aumentado.");
          break;
        case "3":
          state.prestigioInterno = Math.min(100, state.prestigioInterno + 3);
          state.prestigioPublico = Math.min(100, state.prestigioPublico + 1);
          alert("A equipe se sente valorizada. Prestígio melhorou.");
          break;
        case "4":
          state.prestigioInterno = Math.min(100, state.prestigioInterno + 2);
          alert("O chefe aprecia o reconhecimento, mas lembra que resultados contam mais.");
          break;
        default:
          alert("Opção inválida.");
      }
      saveGame();
    }

    function callForensics() {
      alert(
        "O perito responde:\n\n“Posso complementar o laudo se você encontrar novas provas ou inconsistências. Confira o relatório no setor de Provas.”"
      );
    }

    function callStreetUnit() {
      alert(
        "Equipe de rua acionada.\n\nEles executarão mandados de busca e podem retornar com novos elementos em futuros casos."
      );
    }

    // ---------- PROMOTION ----------
    function openPromotion() {
      goTo("promotion");
      const text = document.getElementById("promotion-text");
      text.textContent =
        "Para se candidatar à próxima patente, você precisa de prestígio interno mínimo de 80% e pelo menos 70% de acertos nos casos. Se estiver pronto, pode iniciar a prova de 10 questões.";
    }

    function startPromotionExam() {
      if (state.prestigioInterno < 80) {
        alert("Prestígio interno insuficiente. Mínimo de 80% necessário.");
        return;
      }
      const totalAcc = state.correctAccusations + state.wrongAccusations;
      const rate = totalAcc === 0 ? 0 : (state.correctAccusations / totalAcc) * 100;
      if (rate < 70) {
        alert(
          "Taxa de acertos insuficiente. Você precisa de pelo menos 70% de acertos para tentar promoção."
        );
        return;
      }
      let score = 0;
      for (let i = 1; i <= 10; i++) {
        const ans = prompt(
          "Questão " +
            i +
            " de 10:\n\nEm uma investigação, o que deve vir primeiro?\n\nA) Encontrar um culpado rapidamente\nB) Proteger a cena e preservar provas\nC) Pressionar qualquer suspeito\n\nDigite A, B ou C:"
        );
        if (!ans) continue;
        if (ans.trim().toUpperCase() === "B") score++;
      }
      if (score >= 7) {
        alert(
          "Parabéns! Você acertou " +
            score +
            " de 10. Seu cargo será promovido."
        );
        if (state.agency === "VCPD") {
          if (state.rank === "Detetive Júnior") {
            state.rank = "Detetive Titular";
          } else if (state.rank === "Detetive Titular") {
            state.rank = "Detetive • Casos Especiais";
          } else {
            state.agency = "FBI";
            state.rank = "Agente de Investigação Júnior";
          }
        } else if (state.agency === "FBI") {
          if (state.rank === "Agente de Investigação Júnior") {
            state.rank = "Agente de Investigação Federal";
          } else if (state.rank === "Agente de Investigação Federal") {
            state.rank = "Agente Federal • Casos Especiais";
          } else {
            state.agency = "CIA";
            state.rank = "Analista de Dados Júnior";
          }
        } else if (state.agency === "CIA") {
          if (state.rank === "Analista de Dados Júnior") {
            state.rank = "Agente Nível 1";
          } else if (state.rank === "Agente Nível 1") {
            state.rank = "Agente Nível 2";
          } else if (state.rank === "Agente Nível 2") {
            state.rank = "Agente Nível 3";
          } else if (state.rank === "Agente Nível 3") {
            state.rank = "Agente Nível 4";
          } else {
            state.rank = "Agente Especial";
          }
        }
        saveGame();
        goTo("office");
      } else {
        alert(
          "Você acertou " +
            score +
            " de 10. Ainda não foi desta vez. Continue investigando e tente novamente."
        );
      }
    }

    function openStats() {
      goTo("stats");
    }

    // ---------- CASOS ----------
    function openNextCase() {
      if (state.fired) {
        goTo("fired");
        return;
      }
      if (state.currentCaseIndex === null) {
        state.currentCaseIndex = 0;
      } else if (state.currentCaseIndex < CASES.length - 1) {
        state.currentCaseIndex++;
      } else {
        alert("Nenhum novo caso disponível por enquanto.");
      }
      renderCase();
      goTo("case");
    }

    function getCurrentCase() {
      if (state.currentCaseIndex === null) return null;
      return CASES[state.currentCaseIndex];
    }

    function renderCase() {
      const c = getCurrentCase();
      if (!c) return;
      document.getElementById("case-title").textContent =
        "Caso #" + (state.currentCaseIndex + 1);
      document.getElementById("case-name").textContent = c.name;
      document.getElementById("case-description").textContent = c.description;
      document.getElementById("case-badge").textContent =
        "Nível " + c.level + " • " + c.type;
      document.getElementById("chip-dificuldade").textContent =
        "Dificuldade: " + c.difficulty;
      document.getElementById("chip-tipo").textContent = "Tipo: " + c.type;
    }

    function openWitnesses() {
      const c = getCurrentCase();
      if (!c) return;
      goTo("witnesses");
      document.getElementById("witness-case-name").textContent = c.name;
      const list = document.getElementById("witness-list");
      list.innerHTML = "";
      c.witnesses.forEach((w) => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.onclick = () => selectWitness(w);
        item.innerHTML =
          "<h4>" +
          w.name +
          "</h4><p>" +
          w.relation +
          "</p>";
        list.appendChild(item);
      });

      const qWrap = document.getElementById("witness-quick-questions");
      qWrap.innerHTML = "";
      QUICK_QUESTIONS_WITNESS.forEach((q) => {
        const btn = document.createElement("div");
        btn.className = "q-btn";
        btn.textContent = q;
        btn.onclick = () => askWitnessQuestion(q);
        qWrap.appendChild(btn);
      });

      document.getElementById("witness-statement").textContent =
        "Selecione uma testemunha para ouvir o depoimento.";
    }

    function selectWitness(w) {
      currentWitness = w;
      const text = w.statement;
      typewriterEffect("witness-statement", text);
    }

    function askWitnessQuestion(question) {
      if (!currentWitness) {
        alert("Selecione uma testemunha primeiro.");
        return;
      }
      let answer =
        "A testemunha pensa por um momento e diz que não tem certeza sobre isso.";
      if (currentWitness.qa && currentWitness.qa.length) {
        const qLower = question.toLowerCase();
        for (const qa of currentWitness.qa) {
          if (qa.keywords.some((k) => qLower.includes(k))) {
            answer = qa.answer;
            break;
          }
        }
      }
      typewriterEffect(
        "witness-statement",
        currentWitness.statement +
          "\n\nPergunta: " +
          question +
          "\nResposta: " +
          answer
      );
    }

    function openEvidence() {
      const c = getCurrentCase();
      if (!c) return;
      goTo("evidence");
      document.getElementById("evidence-case-name").textContent = c.name;
      const list = document.getElementById("evidence-list");
      list.innerHTML = "";
      c.evidence.forEach((e) => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML =
          "<h4>" +
          e.name +
          "</h4><p>" +
          e.description +
          "</p>";
        list.appendChild(item);
      });
    }

    function openIMLIfAvailable() {
      const c = getCurrentCase();
      if (!c || !c.needsIML) {
        alert("Não há laudo de IML disponível para este caso.");
        return;
      }
      document.getElementById("iml-report-text").textContent = c.imlReport;
      goTo("iml");
    }

    function openSuspects() {
      const c = getCurrentCase();
      if (!c) return;
      goTo("suspects");
      document.getElementById("suspects-case-name").textContent = c.name;
      const list = document.getElementById("suspects-list");
      list.innerHTML = "";
      c.suspects.forEach((s) => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML =
          "<h4>" +
          s.name +
          "</h4><p>" +
          s.relation +
          " • " +
          s.occupation +
          "</p>";
        item.onclick = () => openSuspectDetail(s);
        list.appendChild(item);
      });
    }

    function openSuspectDetail(s) {
      const msg =
        "Nome: " +
        s.name +
        "\nIdade: " +
        s.age +
        "\nProfissão: " +
        s.occupation +
        "\nRelação: " +
        s.relation +
        "\nEndereço: " +
        s.address +
        "\n\nFicha Criminal: " +
        s.criminalRecord +
        "\n\nÁlibi: " +
        s.alibi +
        "\n\nObservações: " +
        s.profileNotes +
        "\n\nDeseja interrogá-lo agora?";
      if (confirm(msg)) {
        startInterrogation(s);
      }
    }

    function openConcludeCase() {
      const c = getCurrentCase();
      if (!c) return;
      goTo("conclude");
      const list = document.getElementById("conclude-suspects-list");
      list.innerHTML = "";
      c.suspects.forEach((s) => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML =
          "<h4>" +
          s.name +
          "</h4><p>" +
          s.relation +
          " • " +
          s.occupation +
          "</p>";
        item.onclick = () => concludeCaseWithSuspect(s);
        list.appendChild(item);
      });
    }

    function concludeCaseWithSuspect(s) {
      const c = getCurrentCase();
      if (!c) return;
      if (
        !confirm(
          "Confirmar acusação formal contra " +
            s.name +
            "?\nVocê não poderá voltar atrás neste caso."
        )
      ) {
        return;
      }

      state.casesSolved++;
      state.xp += 10;

      if (s.isGuilty) {
        state.correctAccusations++;
        state.prestigioInterno = Math.min(100, state.prestigioInterno + 6);
        state.prestigioPublico = Math.min(100, state.prestigioPublico + 5);
        alert(
          "Acusação correta.\n\nAs provas se alinham e o culpado é responsabilizado."
        );
      } else {
        state.wrongAccusations++;
        if (state.wrongAccusations >= 3) state.warnings++;
        state.prestigioInterno = Math.max(0, state.prestigioInterno - 8);
        state.prestigioPublico = Math.max(0, state.prestigioPublico - 6);
        alert(
          "Acusação incorreta.\n\nA promotoria recusa o caso e sua reputação sofre."
        );
      }

      saveGame();
      state.currentCaseIndex = null;
      goTo("office");
    }

    // ---------- INTERROGATÓRIO ----------
    function startInterrogation(s) {
      currentInterrogationSuspect = s;
      goTo("interrogation");
      document.getElementById("interrogation-title").textContent =
        "Interrogando " + s.name;
      const c = getCurrentCase();
      document.getElementById("interrogation-case-label").textContent =
        c ? c.name : "Caso Atual";
      document.getElementById("interrogation-suspect-label").textContent =
        "Suspeito: " + s.name;

      document.getElementById("interrogation-log").textContent =
        "Você entra na sala de interrogatório. " +
        s.name +
        " observa em silêncio, aguardando sua primeira pergunta.";
      document.getElementById("interrogation-input").value = "";

      const sug = document.getElementById("interrogation-suggestions");
      sug.innerHTML = "";
      INTERROGATION_QUESTIONS.slice(0, 8).forEach((q) => {
        const btn = document.createElement("div");
        btn.className = "q-btn";
        btn.textContent = q;
        btn.onclick = () => {
          document.getElementById("interrogation-input").value = q;
          sendInterrogationQuestion();
        };
        sug.appendChild(btn);
      });
    }

    function sendInterrogationQuestion() {
      if (!currentInterrogationSuspect) return;
      const input = document.getElementById("interrogation-input");
      const question = input.value.trim();
      if (!question) return;

      const answer = getInterrogationAnswer(currentInterrogationSuspect, question);
      const log = document.getElementById("interrogation-log");
      log.textContent +=
        "\n\nVocê: " + question + "\n" + currentInterrogationSuspect.name + ": " + answer;
      input.value = "";
    }

    function getInterrogationAnswer(s, question) {
      const qLower = question.toLowerCase();
      if (s.keywordsAnswers) {
        for (const ka of s.keywordsAnswers) {
          if (ka.keywords.some((k) => qLower.includes(k))) {
            return ka.answer;
          }
        }
      }

      if (qLower.includes("onde") && qLower.includes("estava")) {
        return s.alibi;
      }
      if (qLower.includes("vítima") || qLower.includes("vitima")) {
        return (
          "Minha relação com a vítima é a que você já tem no dossiê: " +
          s.relation +
          "."
        );
      }
      if (qLower.includes("motivo") || qLower.includes("por que") || qLower.includes("porque")) {
        return "Você está tentando forçar um motivo onde não existe. Eu não ganharia nada com esse crime.";
      }
      if (qLower.includes("arma")) {
        return "Eu não tinha nenhuma arma comigo naquela noite.";
      }
      if (qLower.includes("confessar") || qLower.includes("culpado")) {
        return "Não tenho nada para confessar. Eu não cometi esse crime.";
      }

      return "Já respondi tudo que sei sobre isso. Qualquer coisa além será só especulação.";
    }

    // ---------- UTILIDADES ----------
    function typewriterEffect(elementId, text) {
      const el = document.getElementById(elementId);
      if (!el) return;
      if (currentWitnessTypingTimeout) {
        clearTimeout(currentWitnessTypingTimeout);
      }
      el.textContent = "";
      let i = 0;

      function step() {
        if (i <= text.length) {
          el.textContent = text.slice(0, i);
          i++;
          currentWitnessTypingTimeout = setTimeout(step, 15);
        }
      }
      step();
    }

    // ---------- BOOT ----------
    document.addEventListener("DOMContentLoaded", () => {
      preloadImages(BG_IMAGES);

      const raw = localStorage.getItem("valleyCitySave");
      if (raw) {
        try {
          state = JSON.parse(raw);
        } catch (e) {
          state = JSON.parse(JSON.stringify(INITIAL_STATE));
        }
      } else {
        state.casesTotal = CASES.length;
      }
      updateOfficeAvatar();
    });
  </script>
</body>
</html>
